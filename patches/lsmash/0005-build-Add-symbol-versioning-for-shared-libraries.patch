From f74e91fe127b9564c80b1bb95e2ea6fb4bfeda4f Mon Sep 17 00:00:00 2001
From: Yuta NAKAI <nak5124@live.jp>
Date: Sun, 9 Nov 2014 18:47:53 +0900
Subject: [PATCH 5/5] build: Add symbol versioning for shared libraries.

---
 .gitignore  |  2 ++
 Makefile    | 10 +++++++---
 configure   |  4 ++--
 liblsmash.v | 44 ++++++++++++++++++++++++++++++++++++++++++++
 4 files changed, 55 insertions(+), 5 deletions(-)
 create mode 100644 liblsmash.v

diff --git a/.gitignore b/.gitignore
index 9ae81bd..4ff6717 100644
--- a/.gitignore
+++ b/.gitignore
@@ -15,6 +15,8 @@
 *.rej
 *.so*
 *.swp
+*.v
+*.ver
 .depend
 .DS_Store
 config.*
diff --git a/Makefile b/Makefile
index 9fad5ae..a1d93f9 100644
--- a/Makefile
+++ b/Makefile
@@ -7,6 +7,7 @@ include config.mak
 
 vpath %.c $(SRCDIR)
 vpath %.h $(SRCDIR)
+vpath %.v $(SRCDIR)
 
 OBJS = $(SRCS:%.c=%.o)
 
@@ -25,8 +26,8 @@ $(STATICLIBNAME): $(OBJS)
 	$(RANLIB) $@
 	-@ $(if $(STRIP), $(STRIP) -x $@)
 
-$(SHAREDLIBNAME): $(OBJS)
-	$(LD) $(SO_LDFLAGS) $(LDFLAGS) -o $@ $^ $(LIBS)
+$(SHAREDLIBNAME): $(OBJS) liblsmash.ver
+	$(LD) $(SO_LDFLAGS) $(LDFLAGS) -o $@ $(OBJS) $(LIBS)
 	-@ $(if $(STRIP), $(STRIP) -x $@)
 ifneq ($(SLIB_CMD),)
 	$(SLIB_CMD)
@@ -45,6 +46,9 @@ include config.mak2
 %.o: %.c .depend config.h
 	$(CC) -c $(CFLAGS) -o $@ $<
 
+%.ver: %.v
+	sed 's/$$MAJVER/$(MAJVER)/' $^ > $@
+
 install: all install-lib
 	install -d $(DESTDIR)$(bindir)
 	install -m 755 $(TOOLS) $(DESTDIR)$(bindir)
@@ -87,7 +91,7 @@ clean:
 	$(RM) */*.o *.a *.so* *.def *.exp *.lib *.dll *.dylib $(addprefix cli/, *.exe $(TOOLS_ALL)) .depend
 
 distclean: clean
-	$(RM) config.* *.pc
+	$(RM) config.* *.pc *.ver
 
 dep: .depend
 
diff --git a/configure b/configure
index 12e12ac..277e6e3 100755
--- a/configure
+++ b/configure
@@ -67,7 +67,7 @@ is_64bit()
 
 #-----------------------------------------------------------------------------
 
-rm -f config.* .depend conftest* liblsmash.pc
+rm -f config.* .depend conftest* liblsmash.pc liblsmash.ver
 
 
 echo
@@ -261,7 +261,7 @@ esac
 STATICLIBNAME="${STATIC_NAME}${STATIC_EXT}"
 SHAREDLIBNAME="${SHARED_NAME}${SHARED_EXT}"
 test -n "$STATICLIB" && STATICLIB="$STATICLIBNAME"
-test -n "$SHAREDLIB" && SHAREDLIB="$SHAREDLIBNAME"
+test -n "$SHAREDLIB" && SHAREDLIB="$SHAREDLIBNAME" && SO_LDFLAGS="$SO_LDFLAGS -Wl,--version-script,${SRCDIR}/liblsmash.ver"
 test -z "$STATICLIB" -a -z "$SHAREDLIB" && \
     error_exit "--disable-static requires --enable-shared were specified"
 test -z "$SHAREDLIB" && SO_LDFLAGS=""
diff --git a/liblsmash.v b/liblsmash.v
new file mode 100644
index 0000000..2146145
--- /dev/null
+++ b/liblsmash.v
@@ -0,0 +1,44 @@
+LIBLSMASH_$MAJVER {
+        global: lsmash_*;
+                # for cli tools
+                ac3_get_sample_rate;
+                ac3_parse_syncframe_header;
+                dts_get_*;
+                dts_parse_*;
+                dts_setup_parser;
+                dts_update_specific_param;
+                eac3_parse_syncframe;
+                eac3_update_*;
+                h264_calculate_poc;
+                h264_cleanup_parser;
+                h264_find_*;
+                h264_move_pending_avcC_param;
+                h264_parse_sei;
+                h264_parse_slice;
+                h264_setup_parser;
+                h264_supplement_buffer;
+                h264_try_to_append_parameter_set;
+                h264_update_picture_info*;
+                hevc_calculate_poc;
+                hevc_cleanup_parser;
+                hevc_find_*;
+                hevc_move_pending_hvcC_param;
+                hevc_parse_sei;
+                hevc_parse_slice_segment_header;
+                hevc_setup_parser;
+                hevc_supplement_buffer;
+                hevc_try_to_append_dcr_nalu;
+                hevc_update_picture_info*;
+                isom_duplicate_codec_specific_data;
+                isom_get_codec_specific;
+                isom_remove_dcr_ps;
+                mp4a_export_AudioSpecificConfig;
+                mp4a_sampling_frequency_table;
+                vc1_cleanup_parser;
+                vc1_find_*;
+                vc1_parse_*;
+                vc1_setup_parser;
+                vc1_supplement_buffer;
+                vc1_update_au_property;
+        local:  *;
+};
diff --git a/cli/muxer.c b/cli/muxer.c
index d64aa7b..60944d8 100644
--- a/cli/muxer.c
+++ b/cli/muxer.c
@@ -21,6 +21,7 @@
 
 /* This file is available under an ISC license. */
 
+#define LSMASH_INITIALIZE_CODEC_ID_HERE
 #include "cli.h"
 
 #include <stdio.h>
 
-- 
2.1.3

