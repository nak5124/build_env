From 7ad2f7fac19e8bcf2215832299fbd405c262526f Mon Sep 17 00:00:00 2001
From: Yuta NAKAI <nak5124@live.jp>
Date: Mon, 27 Oct 2014 16:01:04 +0900
Subject: [PATCH 4/7] build: Use lib.exe or dlltool when available on mingw.

---
 .gitignore |  1 +
 Makefile   |  9 ++++++++-
 configure  | 27 ++++++++++++++++++++++++++-
 3 files changed, 35 insertions(+), 2 deletions(-)

diff --git a/.gitignore b/.gitignore
index ae1cc88..c9c71c1 100644
--- a/.gitignore
+++ b/.gitignore
@@ -6,6 +6,7 @@
 *.dll*
 *.dylib
 *.exe
+*.exp
 *.lib
 *.o
 *.orig
diff --git a/Makefile b/Makefile
index 7d24d86..9131f85 100644
--- a/Makefile
+++ b/Makefile
@@ -28,6 +28,9 @@ $(STATICLIBNAME): $(OBJS)
 $(SHAREDLIBNAME): $(OBJS)
 	$(LD) $(SO_LDFLAGS) $(LDFLAGS) -o $@ $^ $(LIBS)
 	-@ $(if $(STRIP), $(STRIP) -x $@)
+ifneq ($(SLIB_CMD),)
+	$(SLIB_CMD)
+endif
 ifeq ($(SHAREDLIBNAME), liblsmash.so.$(MAJVER))
 	ln -s $(SHAREDLIBNAME) liblsmash.so
 endif
@@ -59,6 +62,10 @@ ifneq ($(IMPLIB),)
 	install -m 644 $(IMPLIB) $(DESTDIR)$(libdir)
 	install -d $(DESTDIR)$(bindir)
 	install -m 755 $(SHAREDLIB) $(DESTDIR)$(bindir)
+ifneq ($(SLIB_CMD),)
+	install -m 644 $(DEFNAME) $(DESTDIR)$(libdir)
+	install -m 644 lsmash.lib $(DESTDIR)$(bindir)
+endif
 ifeq ($(SHAREDLIB), liblsmash-$(MAJVER).dll)
 	ln -fs $(DESTDIR)$(bindir)/$(SHAREDLIB) $(DESTDIR)$(bindir)/liblsmash.dll
 endif
@@ -77,7 +84,7 @@ uninstall:
 	$(RM) $(addprefix $(DESTDIR)$(bindir)/, $(TOOLS_ALL) $(TOOLS_ALL:%=%.exe) liblsmash.dll cyglsmash.dll)
 
 clean:
-	$(RM) */*.o *.a *.so* *.dll *.dylib $(addprefix cli/, *.exe $(TOOLS_ALL)) .depend *.ver
+	$(RM) */*.o *.a *.so* *.def *.exp *.lib *.dll *.dylib $(addprefix cli/, *.exe $(TOOLS_ALL)) .depend *.ver
 
 distclean: clean
 	$(RM) config.* *.pc
diff --git a/configure b/configure
index a3d11ad..9d96bc3 100755
--- a/configure
+++ b/configure
@@ -56,6 +56,15 @@ cc_check()
     return $ret
 }
 
+is_64bit()
+{
+    echo 'int main(void){int a[2*(sizeof(void *)>4)-1]; return 0;}' > conftest.c
+    $CC conftest.c -o conftest 2> /dev/null
+    ret=$?
+    rm -f conftest*
+    return $ret
+}
+
 #-----------------------------------------------------------------------------
 
 rm -f config.* .depend conftest* liblsmash.pc *.ver
@@ -200,9 +209,22 @@ case "$TARGET_OS" in
         EXT=".exe"
         SHARED_NAME="liblsmash-$MAJVER"
         SHARED_EXT=".dll"
+        DEFNAME="${SHARED_NAME}.def"
         IMPLIB="liblsmash.dll.a"
-        SO_LDFLAGS="-shared -Wl,--out-implib,$IMPLIB -Wl,--version-script,liblsmash.ver"
+        SO_LDFLAGS="-shared -Wl,--output-def,$DEFNAME -Wl,--out-implib,$IMPLIB -Wl,--version-script,liblsmash.ver"
         CFLAGS="$CFLAGS -D__USE_MINGW_ANSI_STDIO=1"
+        LIBARCH=i386
+        if lib.exe --list > /dev/null 2>&1 ; then
+            if is_64bit ; then
+                LIBARCH=x64
+            fi
+            SLIB_CMD='sed -i "s/ @[^ ]*//" $(DEFNAME); lib.exe -machine:$(LIBARCH) -def:$(DEFNAME) -out:lsmash.lib'
+        elif ${CROSS}dlltool --version > /dev/null 2>&1 ; then
+            if is_64bit ; then
+                LIBARCH="i386:x86-64"
+            fi
+            SLIB_CMD="sed -i \"s/ @[^ ]*//\" \$(DEFNAME); ${CROSS}dlltool -m \$(LIBARCH) -d \$(DEFNAME) -l lsmash.lib -D \$(SHAREDLIBNAME)"
+        fi
         ;;
     *cygwin*)
         EXT=".exe"
@@ -427,6 +449,9 @@ CFLAGS = $CFLAGS
 LDFLAGS = $LDFLAGS
 SO_LDFLAGS = $SO_LDFLAGS
 LIBS = $LIBS
+LIBARCH = $LIBARCH
+DEFNAME = $DEFNAME
+SLIB_CMD = $SLIB_CMD
 EOF
 
 cat config.mak
-- 
2.2.0

