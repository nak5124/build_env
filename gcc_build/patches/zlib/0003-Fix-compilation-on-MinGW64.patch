From 9d6ba616b2e8b4e559ec5697715a3b9af889c8ea Mon Sep 17 00:00:00 2001
From: Yuta NAKAI <nak5124@live.jp>
Date: Tue, 5 May 2015 15:05:47 +0900
Subject: [PATCH 3/9] Fix compilation on MinGW64.

---
 arch/x86/crc_folding.c   | 2 +-
 arch/x86/deflate_quick.c | 4 ++--
 arch/x86/x86.h           | 6 +++++-
 zutil.h                  | 2 +-
 4 files changed, 9 insertions(+), 5 deletions(-)

diff --git a/arch/x86/crc_folding.c b/arch/x86/crc_folding.c
index 262f339..5a4e975 100644
--- a/arch/x86/crc_folding.c
+++ b/arch/x86/crc_folding.c
@@ -285,7 +285,7 @@ ZLIB_INTERNAL void crc_fold_copy(deflate_state *z_const s,
         goto partial;
     }
 
-    algn_diff = (0 - (unsigned long)src) & 0xF;
+    algn_diff = (0 - (uintptr_t)src) & 0xF;
     if (algn_diff) {
         xmm_crc_part = _mm_loadu_si128((__m128i *)src);
         _mm_storeu_si128((__m128i *)dst, xmm_crc_part);
diff --git a/arch/x86/deflate_quick.c b/arch/x86/deflate_quick.c
index 338af0e..1459a1b 100644
--- a/arch/x86/deflate_quick.c
+++ b/arch/x86/deflate_quick.c
@@ -22,7 +22,7 @@ extern void flush_pending  (z_stream *strm);
 local inline long compare258(z_const unsigned char *z_const src0,
         z_const unsigned char *z_const src1)
 {
-    long ax, dx, cx;
+    intptr_t ax, dx, cx;
     __m128i xmm_src0;
 
     ax = 16;
@@ -152,7 +152,7 @@ local inline Pos quick_insert_string(deflate_state *z_const s, z_const Pos str)
         "crc32l (%[window], %[str], 1), %0\n\t"
     : "+r" (h)
     : [window] "r" (s->window),
-      [str] "r" ((long)str)
+      [str] "r" ((intptr_t)str)
     );
 
     ret = s->head[h & s->hash_mask];
diff --git a/arch/x86/x86.h b/arch/x86/x86.h
index f68663e..2ee4783 100644
--- a/arch/x86/x86.h
+++ b/arch/x86/x86.h
@@ -6,7 +6,11 @@
 #ifndef CPU_H
 #define CPU_H
 
-#define ZLIB_INTERNAL __attribute__((visibility ("hidden")))
+#if defined(HAVE_HIDDEN) && !defined(__MINGW32__)
+#  define ZLIB_INTERNAL __attribute__((visibility ("hidden")))
+#else
+#  define ZLIB_INTERNAL
+#endif
 
 extern int x86_cpu_has_sse2;
 extern int x86_cpu_has_sse42;
diff --git a/zutil.h b/zutil.h
index 5feddb2..ca0d5bc 100644
--- a/zutil.h
+++ b/zutil.h
@@ -13,7 +13,7 @@
 #ifndef ZUTIL_H
 #define ZUTIL_H
 
-#ifdef HAVE_HIDDEN
+#if defined(HAVE_HIDDEN) && !defined(__MINGW32__)
 #  define ZLIB_INTERNAL __attribute__((visibility ("hidden")))
 #else
 #  define ZLIB_INTERNAL
-- 
2.4.0

