From 4b3446eb087d33599c521fa21d1c4bbbab9d7de2 Mon Sep 17 00:00:00 2001
From: Yuta NAKAI <nak5124@live.jp>
Date: Sat, 9 May 2015 00:57:54 +0900
Subject: [PATCH 2/8] Fix compilation on MinGW64.

---
 arch/x86/crc_folding.c   | 4 ++--
 arch/x86/deflate_quick.c | 9 +++++----
 arch/x86/x86.h           | 6 +++++-
 3 files changed, 12 insertions(+), 7 deletions(-)

diff --git a/arch/x86/crc_folding.c b/arch/x86/crc_folding.c
index 262f339..fbf5f89 100644
--- a/arch/x86/crc_folding.c
+++ b/arch/x86/crc_folding.c
@@ -273,7 +273,7 @@ local void partial_fold(deflate_state *z_const s, z_const size_t len,
 ZLIB_INTERNAL void crc_fold_copy(deflate_state *z_const s,
         unsigned char *dst, z_const unsigned char *src, long len)
 {
-    unsigned long algn_diff;
+    uint64_t algn_diff;
     __m128i xmm_t0, xmm_t1, xmm_t2, xmm_t3;
 
     CRC_LOAD(s)
@@ -285,7 +285,7 @@ ZLIB_INTERNAL void crc_fold_copy(deflate_state *z_const s,
         goto partial;
     }
 
-    algn_diff = (0 - (unsigned long)src) & 0xF;
+    algn_diff = (0 - (uintptr_t)src) & 0xF;
     if (algn_diff) {
         xmm_crc_part = _mm_loadu_si128((__m128i *)src);
         _mm_storeu_si128((__m128i *)dst, xmm_crc_part);
diff --git a/arch/x86/deflate_quick.c b/arch/x86/deflate_quick.c
index 338af0e..5685c5f 100644
--- a/arch/x86/deflate_quick.c
+++ b/arch/x86/deflate_quick.c
@@ -14,15 +14,16 @@
  */
 
 #include "deflate.h"
+#include <stdint.h>
 #include <immintrin.h>
 
 extern void fill_window_sse(deflate_state *s);
 extern void flush_pending  (z_stream *strm);
 
-local inline long compare258(z_const unsigned char *z_const src0,
+local inline int64_t compare258(z_const unsigned char *z_const src0,
         z_const unsigned char *z_const src1)
 {
-    long ax, dx, cx;
+    intptr_t ax, dx, cx;
     __m128i xmm_src0;
 
     ax = 16;
@@ -152,7 +153,7 @@ local inline Pos quick_insert_string(deflate_state *z_const s, z_const Pos str)
         "crc32l (%[window], %[str], 1), %0\n\t"
     : "+r" (h)
     : [window] "r" (s->window),
-      [str] "r" ((long)str)
+      [str] "r" ((intptr_t)str)
     );
 
     ret = s->head[h & s->hash_mask];
@@ -163,7 +164,7 @@ local inline Pos quick_insert_string(deflate_state *z_const s, z_const Pos str)
 ZLIB_INTERNAL block_state deflate_quick(deflate_state *s, int flush)
 {
     IPos hash_head;
-    unsigned dist, match_len;
+    uint64_t dist, match_len;
 
     static_emit_tree(s, flush);
 
diff --git a/arch/x86/x86.h b/arch/x86/x86.h
index f68663e..aa86b2c 100644
--- a/arch/x86/x86.h
+++ b/arch/x86/x86.h
@@ -6,7 +6,11 @@
 #ifndef CPU_H
 #define CPU_H
 
-#define ZLIB_INTERNAL __attribute__((visibility ("hidden")))
+#ifdef HAVE_HIDDEN
+#  define ZLIB_INTERNAL __attribute__((visibility ("hidden")))
+#else
+#  define ZLIB_INTERNAL
+#endif
 
 extern int x86_cpu_has_sse2;
 extern int x86_cpu_has_sse42;
-- 
2.4.0

