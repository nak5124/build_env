From f32e45dfcf8376f6961b23de02f4d05562f121a1 Mon Sep 17 00:00:00 2001
From: Yuta NAKAI <nak5124@live.jp>
Date: Sat, 13 Jun 2015 15:58:15 +0900
Subject: [PATCH 19/21] gcc: Force linking to libgcc_s_dw2-1.dll on mingw32
 with dw2 eh.

---
 gcc/config/i386/cygwin.h  | 6 +++++-
 gcc/config/i386/mingw32.h | 8 ++++++--
 2 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/gcc/config/i386/cygwin.h b/gcc/config/i386/cygwin.h
index 2186937..7f71ccc 100644
--- a/gcc/config/i386/cygwin.h
+++ b/gcc/config/i386/cygwin.h
@@ -55,6 +55,10 @@ along with GCC; see the file COPYING3.  If not see
     fvtable-verify=std:vtv_end.o%s} \
    crtend.o%s"
 
+/* There is a bug when building i686 dw-2 exceptions
+   where gcc_s gets stripped which this works around */
+#define PREVENT_STRIP_REG_FRAME_INFO "--undefined=___deregister_frame_info --undefined=___register_frame_info"
+
 /* Normally, -lgcc is not needed since everything in it is in the DLL, but we
    want to allow things to be added to it when installing new versions of
    GCC without making a new CYGWIN.DLL, so we leave it.  Profiling is handled
@@ -65,7 +69,7 @@ along with GCC; see the file COPYING3.  If not see
  %{static|static-libgcc:-lgcc -lgcc_eh} \
  %{!static: \
    %{!static-libgcc: \
-     -lgcc_s -lgcc \
+     -lgcc_s " PREVENT_STRIP_REG_FRAME_INFO " -lgcc \
     } \
   } "
 #else
diff --git a/gcc/config/i386/mingw32.h b/gcc/config/i386/mingw32.h
index eb58fcc..b15cde0 100644
--- a/gcc/config/i386/mingw32.h
+++ b/gcc/config/i386/mingw32.h
@@ -138,6 +138,10 @@ along with GCC; see the file COPYING3.  If not see
   %(shared_libgcc_undefs) \
   %{!shared: %{!mdll: --large-address-aware --tsaware --pic-executable " SUB_PIE_ENTRY "}}"
 
+/* There is a bug when building i686 dw-2 exceptions
+   where gcc_s gets stripped which this works around */
+#define PREVENT_STRIP_REG_FRAME_INFO "--undefined=___deregister_frame_info --undefined=___register_frame_info"
+
 /* Include in the mingw32 libraries with libgcc */
 #ifdef ENABLE_SHARED_LIBGCC
 #define SHARED_LIBGCC_SPEC " \
@@ -146,9 +150,9 @@ along with GCC; see the file COPYING3.  If not see
    %{!static-libgcc: \
      %{!shared: \
        %{!shared-libgcc:-lgcc -lgcc_eh} \
-       %{shared-libgcc:-lgcc_s -lgcc} \
+       %{shared-libgcc:-lgcc_s " PREVENT_STRIP_REG_FRAME_INFO " -lgcc} \
       } \
-     %{shared:-lgcc_s -lgcc} \
+     %{shared:-lgcc_s " PREVENT_STRIP_REG_FRAME_INFO " -lgcc} \
     } \
   } "
 #else
-- 
2.4.3

