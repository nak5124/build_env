# Maintainer: Yuta Nakai <nak5124@live.jp>

_realname=ffmpeg
pkgbase=mingw-w64-$_realname
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}-git"
pkgdesc='Complete and free Internet live audio and video broadcasting solution (mingw-w64)'
pkgver=2.9.75570.3e5b02b
pkgrel=1
arch=('any')
url='http://ffmpeg.org/'
license=('GPL' 'nonfree')
provides=("${MINGW_PACKAGE_PREFIX}-${_realname}")
conflicts=("${MINGW_PACKAGE_PREFIX}-${_realname}")
makedepends=('git'
             'pkgconf'
             "${MINGW_PACKAGE_PREFIX}-mfx_dispatch"
             "${MINGW_PACKAGE_PREFIX}-opencl")
depends=("${MINGW_PACKAGE_PREFIX}-SDL"
         "${MINGW_PACKAGE_PREFIX}-bzip2"
         "${MINGW_PACKAGE_PREFIX}-dcadec"
         "${MINGW_PACKAGE_PREFIX}-liblzma"
         "${MINGW_PACKAGE_PREFIX}-libutvideo"
         "${MINGW_PACKAGE_PREFIX}-libvorbis-aotuv"
         "${MINGW_PACKAGE_PREFIX}-libvpx"
         "${MINGW_PACKAGE_PREFIX}-opencore-amr"
         "${MINGW_PACKAGE_PREFIX}-openh264"
         "${MINGW_PACKAGE_PREFIX}-openmj2"
         "${MINGW_PACKAGE_PREFIX}-opus"
         "${MINGW_PACKAGE_PREFIX}-speex"
         "${MINGW_PACKAGE_PREFIX}-toolchain"
         "${MINGW_PACKAGE_PREFIX}-x264-10bit"
         "${MINGW_PACKAGE_PREFIX}-x265-hg")
source=("${_realname}"::'git://source.ffmpeg.org/ffmpeg.git'
        '0001-get-accurate-estimate-from-the-PTSes.patch'
        '0002-HACK-Disable-tb_unreliable-preserve-original-fps-inf.patch'
        '0003-aacdec-construct-extradata-if-it-wasn-t-present-befo.patch'
        '0004-Increase-the-maximum-probe-size-to-4MB.patch'
        '0005-prores-set-avtx-pix_fmt-based-on-the-fourcc-code-dur.patch'
        '0006-Silently-error-out-when-pos_limit-exceeds-pos_max-in.patch'
        '0007-mpegts-switch-back-to-mpegts_get_pcr.patch'
        '0008-file-increase-io-buffer-for-better-performance-on-hi.patch'
        '0009-mpegvideo-null-out-current_picture_ptr-when-allocati.patch'
        '0010-h264-flag-interlaced-coded-frames-as-such-when-sei_p.patch'
        '0011-HACK-preserve-mpeg2-END_OF_SEQ-code-to-the-start-of-.patch'
        '0012-HACK-mov-when-seeking-secondary-streams-don-t-insist.patch'
        '0013-aac-7.1-should-have-side-channels-and-not-2-pairs-of.patch'
        '0014-Revert-mpegts-clear-avprograms-only-for-removed-prog.patch'
        '0015-HACK-avio-add-a-flag-to-skip-the-fstat-on-file-openi.patch'
        '0016-flac-export-vorbiscomment-metadata-in-extradata.patch'
        '0017-swscale-make-sws_getCachedContext-properly-handle-pr.patch'
        '0018-h264-set-h-sps-if-none-is-set-yet.patch'
        '0019-riff-don-t-try-to-parse-too-small-WAVEFORMAT-headers.patch'
        '0020-Fraps-output-repeat-frames-instead-of-discarding-the.patch'
        '0021-vorbiscomment-allow-using-vorbiscomment-parser-witho.patch'
        '0022-dca-parse-the-HD-frame-size-to-avoid-false-positive-.patch'
        '0023-avidec-remove-an-assert.patch'
        '0024-riff-add-HEVC-tags.patch'
        '0025-HACK-hevc-ignore-invalid-extradata.patch'
        '0026-h264-increase-MAX_SLICES-to-256.patch'
        '0027-vc1-wait-for-bitstream-recovery-before-starting-deco.patch'
        '0028-h264-don-t-use-deprecated-YUVJ-pixel-formats.patch'
        '0029-HACK-mov-don-t-set-the-DEFAULT-disposition-because-o.patch'
        '0030-avformat-utils-don-t-overwrite-existing-program-info.patch'
        '0031-avformat-try-harder-to-find-a-duration-of-the-media.patch'
        '0032-riff-add-ProRes-FourCCs.patch'
        '0033-hevc-port-intrinsic-SSE2-IDCT-from-OpenHEVC.patch'
        '0034-hevc-port-intra-pred-SIMD-from-OpenHEVC.patch'
        '0035-h264_parser-force-grabing-a-new-timestamp-until-a-fr.patch'
        '0036-x86-hevc-use-DECLARE_ALIGNED-for-on-stack-tmp-arrays.patch'
        '0037-mpeg12dec-properly-handle-a-codec_id-change.patch'
        '0038-hevc-don-t-use-deprecated-YUVJ-pixel-formats.patch'
        '0039-dca_parser-don-t-overwrite-the-sample-rate-it-may-no.patch'
        '0040-dca_parser-fix-parsing-of-dts-hd-header-sizes-on-hd-.patch'
        '0041-isom-Support-demuxing-more-DTS-audio-in-ISOBMFF.patch'
        '0042-Revert-avformat-mov-strengthen-some-table-allocation.patch'
        '0043-mov-Support-roll-recovery-grouping.patch'
        '0044-dirac_parser-Set-output_picture_number.patch'
        '0045-alsdec-Fix-avoiding-reading-over-the-end-of-packet-d.patch'
        '0046-flvdec-Support-HM10.0-based-Strongene-HEVC-demuxing.patch'
        '0047-hevc-Set-chroma_sample_location-of-AVCodecContext.patch'
        '0048-h264_ps-Set-chroma_sample_location-appropriately-if-.patch'
        '0049-fix-compilation-on-msys2-mingw32-system.patch'
        '0050-Revert-avcodec-h264-fix-Lossless-Decoding-Profile-24.patch'
        '0051-avcodec-libvpxenc-Use-VP9E_SET_NOISE_SENSITIVITY-for.patch'
        '0052-Revert-avcodec-opusdec-switch-to-swresample.patch'
        '0053-build-Cleanup-version-scripts.patch'
        '0054-avcodec-allcodecs-Prefer-several-external-libraries-.patch'
        '0055-configure-Fix-detection-of-functions-on-mingw-w64.patch'
        '0056-libutvideodec-Fix-bits_per_raw_sample.patch'
        '0057-libavcodec-libutvideo-dec-enc-Fix-compilation-with-l.patch'
        '0058-libavformat-os_support.h-Fix-multiple-redefinition-e.patch'
        '0059-ffmpeg-Don-t-show-banner-by-default.patch'
        '0060-asfdec-Prefer-asfdec_o-over-asfdec_f.patch')
sha512sums=('SKIP'
            '5ed1d23ed04abd493be581f8be61910dab6b755c5fe7cf4f79d437db9fb35cd41e5136e3e01af7f3caed22e5e1e6ecaf3a6b27ee995d337cb7a3a1b92aa6e0d3'
            'b7b2c92f300e88a8fb05c87c8ed819f1f7cc383619a4ae5c95be5307482a2ffb9431ba7483f51827bac61791da71e97d09761cf7f65d0181c88b25c110280d24'
            '717c40e1e482e381cd637bc6c15f2e78e12242784da892949eb7eeb3aa376973f97ff4e9efaa105918832a0d7a634f37e5716108d4e9a6ea257098cdac11c8c8'
            'ca41fcd3ec2c8f03b9e9be63dcc6bbfd016de22dc618b205d2bab51d35525619ae633742b3a0f11664f8d003734bd18e70a4d81a7181e2c9b4e410dc89a38bc6'
            'e90ca48450df1775970251e3bc66460ce4e54f2bc7a29d6106616fb804596bf3cfe9c8baad49eaf230d490f337b3c3fc61f6378162c251a6e4e5a3923126e280'
            '1347275099b70c4b083747405bbf6846fcd7f4cd52e8f6d2d005879a2fd9d8bbfd6bcffdd4618aea6163aaffd127848768e222372e3b036f2649ac9fb50f635c'
            '2d68d0f46f52d16400c574da3c57b594d156efa89d83cdaf430f0c92bd4fbf099d02b0e7ea0da1839f4063ccc3992b2d60cdc92147adbaa3c876aa39fed2896c'
            '0a31eb3d3826685e5e5ac9ca48a43ded5cc37ae4795ab18849a7b44b9d3540b27eee5b4971f05b236d3d8f03d5e82c4738d07075c5b452b9f328213de591a536'
            'e479abff07eb100c41993d4e8ecc08399440fe213f89e8d2933d79574839b40d27dd00b3fe92da686cb521152a774ce3c1d4399b2c23fc50fe70f86ea98380b2'
            'f403b849950aa7ffe17c8c3d0515e24575b1b98c7c96fd274dda8c33ed4ce51be83de19064778e665a5d3fbf13e2f7ceddf7c9416de61e2b5037bbd31d486b26'
            'a30b3d898882c16ff29a6200403976e0ba97a8382b4b388b3335aed13858002b2819a5961280ff40a7698b2371f7f49229c11661df523f3b53a788307cf2227d'
            'd041cdca5db9b6dba03e041762402e60ed326b8c460fda1c34f72883586831aa68fc6fff9a3f59143625f3d3419330a66d4cc6fcedb7e7dfb2d27edf6a14ce0b'
            'c1a99b1a82e1ff418884091058c375a174c7618afc6b5da80b1bcf98f2034543fd2281dfa3927dace5d0f33a5ed5384424b3bd1bee4ca9417cfb5f3090b1f2f6'
            '161d49b61bc3d7d74f76c60bdf8b1ea5612e9bb76a02c72887e6f42946555c04c884762bb4e242b3007f4398a5007c7704c0d303f7ea07bb8160092da9320342'
            '2ed41827e91c64fe09cc9831aaadf0fc63ccc19c30e67ec220847f04459396cf76f0c39270f998376ecc8a8b5c8f3af1b9eac9751db63fcb30657898d5a8c2b9'
            '0bace75ef8e138024290d1aa9f4b7c10f1dd049017729e801a905e857afdf9ae1e9f01c31986732567924b976c8f79e6ae7b875c026005d79cf8088cdf0eed32'
            '9212df92b28bfc8bb68bd484001ca8d3733827ce8dd930197fade38fe07b1f8b5ddcf2088b98c6f8cc8de3f1ea093f16d7a0e6408d23fc8e2cce09f010a9266f'
            '1695d67dc3677fa164397c706ef00db0220f88fd76881bbdc0852f5ae8349fa64f463d881ca272444cb37e76bd60b56c92ad39530f4ff28bd9889d8d713bdf7e'
            '7cd9f2b494e6e51676cf5c32f5206c95d737670ac4bcb3f7153677ec109c28c20426c0e96f0f6e7dcd55707b4178a96128e0015a7c4081e72241ec5e0d48671e'
            '1a9e87a01414b8c495d66f77e1d7e69fbdc0a52673e0c2b82f34bdba9fcad7feb82bd77a703c080fcccc197a7ed8b594ce01c89957d07844262e80edc0f9f88c'
            'a38f84de1e805182ce472522fca0804285f909d5abbcf64b71da6a303331257fd4c1353e01dd814c23eedb99005880727de2161c39a4ba1211d5c484adb329c4'
            '7ab49f7f15397b4018924b0aa32ea3d1c61a9caa2c120f957327a389236c9dfd0e0fa1bffa2d30e5b2f6dc8222f745094f979078b65237730b5b3aefcb1abed9'
            'c94d9640f526dd8ea9842ce789970c2a8a78f0c319c08fd75eabd1a42ae09c02fdb22962aa16b298a431b5bc31b352bc44598a4ef87dc30e3341bfe473888968'
            '32283f17465bd40f66702a4103cc28d9bf45829d920c7649baf84bf4ae8e43e42987e192513ed061fa89fbdd64c85f8ac57d48dd6f05dd7fd69f08912ddb1608'
            '65c7cde6d7a00ebcc1abe2d74446019bbffb5d119418c1bd2c73b83b9729695e2084702579380f9cc13271c9e6aac2878e5856fc5c838cab27f1aef7f8b54b43'
            '7190c10289ea266cb5549273fa48d128da77b27d49366b2cd5a2b1e0dc418f13c77ee44b489c0661cea608e5144e74679acb0db2d5366b000bc4afd62c6281d4'
            '61378a5e5ce40a40dee59b1be5b84cb3022b449a68d346459e275bdb422ed5d4796c1c4da94f9b0c6c2048f8d832d79fbe87064bccb11ac9c40ecd88f153160b'
            '19e89924ffe8eb93917fa0a72fbd8d398a01c347d089a07c6825030d8860112a1ccdab822a11733822b5f4a81d49c42b32de474f9d647e5fd7f3df16bb1492d4'
            '268b07b6725066a97002a5f83862ee791af1875a7674688facf272f1308adb6fd3ba836d8c7a0e16f0bc5eaf03b9e11f58d7279beb1291aa6d117e79eb2dfd09'
            '89e52e0fcb860fd9ea7e795e1b7955f5f7e845296a9fe43f8cdcd3f6bde1af5759cae1b6f288b642fdcf22db7986b8496adb2f0199935f64c7473cc55c76d907'
            '973b944155e18a129c0a97e09912ae50c335e3d1ee31d6d05f572770f5c0b815c0cbef12e6aba9b54eb42ba61f3ad80f6f76b67fe9ef684b5a4f62a3aa41d266'
            'bd2e5a41c88e55a7dfcc77c8a5ead72dcb559c1eadfe360ce97e696a93915f6daa39e2ea31fe698b8cc82618bd1a89d00776e9945e544faeed1d752a80662e40'
            '33fc7282797a58c7c92fc716f919f02a17f44cb1707699729d7a113f13c4bfde5e9ee5a95f787a3be01de6f638e3929b0d563bee119bda0bbd230e8be070779f'
            'e4e769e243e1537f4a8ca433ae243480fe1fb408e0cb37a1030fff5b9d3ca46b9a952c824c32753237ba11709496a73152a2c58b1ce623a9ce6ad21bf2845051'
            '2b50a4456d7bfc19540faf5cc4322110cb1f20a893f2e6061981343608ade6222be5cbd1e6ca88b7e62e7b60ed932915a69e32a3c5b580ed2082b5389310322a'
            '2816f8792a5f03d7f73cdec504b5aa1bb308a20e7d8969242b9ae32aaccf708cc9bea8e017c3c6427a2c16240fd44eb91d88872e289f71d1730e9473276e1478'
            'f0e1d3c2c6590c330b46ff0c7a653a501cd52d69591a617abe105c8c16fe64ff699d7983f86902d223558cc8b387c62ead7710971ef0a075782c858bb015e849'
            'df9f29ceaf326d1da1e9eec340af8419f2572b899646325ad59f1920a1cb9454bd8f88a7a99f62d2b6b6a950dd15d467e9546fdf5619264343d820c7395d5da8'
            '45c6df217fe1818fc392a2d7c1b73dad8f603edd569788ee5aaf0661ece23a351c75a0321aa84885c80ce9acefbf418b1dc33b9a16ee4c2ef7828e779c243289'
            'c21c1fc4f1e105e2ec00c635eb4e889535545b90979c1b99da816a770b026691de3285ff7deafdc5b869b065b5d2edde788a8142051b163feaf73225d96c5ad7'
            '53b757e417ef56eae434a29912851c9fe81485914662be2ffc6b586fba80af76e6c41cc9d08076cd9a3c0532586efc79ff2d744ab9e3b7bddbfccc8c4bcd90b2'
            'c677c74a46071f35b263a4ec1c74d93bfb54ccb346853aa582be102dd163744333146fd4588735f4f1f3a0efbab5e34a279d849586b12315343179f861c70c65'
            '43829c36728d8388dfe1a8a42cd983c286e4b40e4b1e0f65c757121f0259b4945b7e45ef4dd749c35b1dccb94c0a65c5e85663b9fdb989901341de6434c5db8f'
            '61e67c9276446c4d7b2cc26ed38e97aa785a00199bcad23bb6dfdd3fdba66aee516371b22398e70917b7b68be29ff09e146b05526940292f299fa6bdbb441d65'
            '40480c5439b6d71c48bb15c029c6c2e2d6840ac0d6aa5b0dabec18e22d4f235fd43d4b6b3cc2b71dd7fb35b9398064c2ce6c595028153c0ee568ce1699ef6c8b'
            '070b65ead557b3b04fa19c53e3e52837656d9c754de44c780d075f0ae1971b147349373dacbc09a6d51b06c4bb215a0468991d63ea240c0d631ed50ab8f30d1a'
            'b09e0fb215a0f3127f6ed75863ba09e4b70586f72bc923881cb76e2815827a6a46030e501e53dbdcd692edfcca332acbea2bcf88626bc497c54e12320336b7b6'
            'b5b52eed2fd119a1ddb8bed39bd25dc37f5ecd37d508d49ba154fe2d160e8d1e28ef843742b7d2e39d26bba9e1e1b7f8d745d088ee7e25b77544010392f2f90e'
            '0bb25c326cf8055e6c3a44b6f65df211192de8f17af7ca8ca70142c2910b627a3904ae97ea7ac635905344c994c082f7e9e0b10d5bc31fb33896731c22c31b71'
            'f9c034b7c97bb1cd621cf7cc966b504d14f66fb0bf2558cb102f03ad7e6b11a80374ebbf01f1f827ab0d202aba4ab809fe369024b379fe7867c5167f002b4365'
            'b38d2482eb6a1732581f1af4b24453ea313f173f7b43038c9b61fa1544f8e718178250cc82b4726ccec178a8d2ecf19435d946761870910f5c3c4c816af095ec'
            'd845e4a447049dffd67eb7f91dfc1eec75830419ee5c2a2bb07757beaccacdd9086e5314f4026c5bbf714a4ca9fdf003ebc91c089f3d17904fbfb938f1b60c34'
            '7ec6c8dce841556709149d891cab0ad100afa524aac0f0aa324a41bb21ab0fc903aae8eef69bb6fdeb9fac76c80f32a703b66d4547654bf8a7539fb05ba13bf3'
            '09e58f69942879bd2e5a1c3138a3505aafd87d8b39a159c593af2e3e83e04454983fd25ee34aa64ef8e0d60120ba6731a16f63913a3699a4229b0a1386d1004d'
            'c48f5ec540fe45904354cbc96b1a41a3258f76d75be0a9310d6f94e57f7fd7de5607422c0b7f55dc14c9eafacf442976eece620e845482c7c4607041651c7161'
            'd4950eb23175d94b4af77b976a10a7d8a18064a2b6c5ad99538f69042aed4d41f0a79fda42e6f84785280151a3884c653f69e6097d6e76b165702e7a4335a595'
            'a82514a4ad3b49e1ca08c5a15ecfa970ae0b4ccd4e099b539e09c6a34fd34d951f5984a2487cf373f720a6e57ab87afb342af7d7dbd781152ed3eae06382fee0'
            'efc9f21cbece53602e8ba1fc8d8015ffb3556c454b2f7fcadb45d13bec7e365410236297b25dc8a0b24740e36d138ddc3af618db814ce9d945b852c0c2476b15'
            '3dbd28ab1a07860b7e1c26d21e5b57e725b38a97aa6d5f541aaacaa4f738b7f660fea292ad78f2f661e43b2ac972a68691fb6d2d9712dd4cd11d4c2eb6ac3a17'
            '575c436f46e60c9746170bea77cf3fda41c70cfdb2368352ebfc9621c2bc1aed4cb1c8356eddc48077e8bbf6c872284230654c3e711c44da615128ac245407b3')

pkgver() {
  cd "${srcdir}"/$_realname
  local _ver=$(git describe | awk -F"-" '{ print $1}' | sed 's/n//g')
  printf "%s.%s.%s" "${_ver}" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
  cd "${srcdir}"/$_realname

  git clean -fdx

  local -i _N=60
  local -i _i
  local _num
  msg2 'Apply patches'
  for _i in $(seq 1 ${_N})
  do
    _num=$(printf "%04d" ${_i})
    printf "\n========== patch No.%s ==========\n" $_num
    patch -p1 -i "${srcdir}"/${_num}*.patch
  done
}

build() {
  cd "${srcdir}"/$_realname

  if [ "${MINGW_CARCH}" = "x86_64" ]; then
    PATH=${PATH}:$VC64_DIR
  else
    PATH=${PATH}:$VC32_DIR
  fi
  export PATH

  if [ -f "${MINGW_LOCAL_PREFIX}/include/nvEncodeAPI.h" ]; then
    local _nvenc='--enable-nvenc --enable-nonfree'
  else
    local _nvenc=''
  fi

  ./configure \
    --prefix=$MINGW_LOCAL_PREFIX \
    --enable-gpl \
    --enable-version3 \
    --disable-static \
    --enable-shared \
    --enable-gray \
    --enable-avresample \
    --disable-pthreads \
    --enable-avisynth \
    --enable-libdcadec \
    --enable-libmfx \
    --enable-libopencore-amrnb \
    --enable-libopencore-amrwb \
    --enable-libopenh264 \
    --enable-libopenjpeg \
    --enable-libopus \
    --enable-libspeex \
    --enable-libutvideo \
    --enable-libvorbis \
    --enable-libvpx \
    --enable-libx264 \
    --enable-libx265 \
    $_nvenc \
    --enable-opencl \
    --enable-opengl \
    --arch=${MINGW_CARCH/i6/x} \
    --cpu=sandybridge \
    --extra-ldflags="${LDFLAGS}" \
    --optflags="${CFLAGS} ${CPPFLAGS}" \
    --disable-symver \
    --sws-max-filter-size=512 \
    --disable-debug

  make clean
  make $MAKEFLAGS V=1
}

package() {
  cd "${srcdir}"/$_realname
  make DESTDIR="${pkgdir}" install install-man V=1
}
