# Maintainer: Yuta Nakai <nak5124@live.jp>

_realname=ffmpeg
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}-git"
pkgdesc='Complete and free Internet live audio and video broadcasting solution (mingw-w64)'
pkgver=2.7.72462.0363776
pkgrel=1
arch=('any')
url='http://ffmpeg.org/'
license=('GPL' 'nonfree')
makedepends=('git'
             'pkgconf'
             "${MINGW_PACKAGE_PREFIX}-mfx_dispatch-git"
             "${MINGW_PACKAGE_PREFIX}-opencl")
depends=("${MINGW_PACKAGE_PREFIX}-SDL"
         "${MINGW_PACKAGE_PREFIX}-dcadec-git"
         "${MINGW_PACKAGE_PREFIX}-liblzma-git"
         "${MINGW_PACKAGE_PREFIX}-libutvideo-git"
         "${MINGW_PACKAGE_PREFIX}-libvorbis-aotuv"
         "${MINGW_PACKAGE_PREFIX}-libvpx-git"
         "${MINGW_PACKAGE_PREFIX}-opencore-amr-git"
         "${MINGW_PACKAGE_PREFIX}-openh264-git"
         "${MINGW_PACKAGE_PREFIX}-openmj2-svn"
         "${MINGW_PACKAGE_PREFIX}-opus-git"
         "${MINGW_PACKAGE_PREFIX}-speex-git"
         "${MINGW_PACKAGE_PREFIX}-toolchain"
         "${MINGW_PACKAGE_PREFIX}-x264-10bit-git"
         "${MINGW_PACKAGE_PREFIX}-x265-10bit-hg")
source=("${_realname}"::'git://source.ffmpeg.org/ffmpeg.git'
        '0001-get-accurate-estimate-from-the-PTSes.patch'
        '0002-HACK-Disable-tb_unreliable-preserve-original-fps-inf.patch'
        '0003-aacdec-construct-extradata-if-it-wasn-t-present-befo.patch'
        '0004-Increase-the-maximum-probe-size-to-4MB.patch'
        '0005-prores-set-avtx-pix_fmt-based-on-the-fourcc-code-dur.patch'
        '0006-Silently-error-out-when-pos_limit-exceeds-pos_max-in.patch'
        '0007-mpegts-switch-back-to-mpegts_get_pcr.patch'
        '0008-file-increase-io-buffer-for-better-performance-on-hi.patch'
        '0009-mpegvideo-null-out-current_picture_ptr-when-allocati.patch'
        '0010-h264-flag-interlaced-coded-frames-as-such-when-sei_p.patch'
        '0011-HACK-preserve-mpeg2-END_OF_SEQ-code-to-the-start-of-.patch'
        '0012-HACK-mov-when-seeking-secondary-streams-don-t-insist.patch'
        '0013-aac-7.1-should-have-side-channels-and-not-2-pairs-of.patch'
        '0014-Revert-mpegts-clear-avprograms-only-for-removed-prog.patch'
        '0015-HACK-avio-add-a-flag-to-skip-the-fstat-on-file-openi.patch'
        '0016-flac-export-vorbiscomment-metadata-in-extradata.patch'
        '0017-swscale-make-sws_getCachedContext-properly-handle-pr.patch'
        '0018-h264-set-h-sps-if-none-is-set-yet.patch'
        '0019-riff-don-t-try-to-parse-too-small-WAVEFORMAT-headers.patch'
        '0020-Fraps-output-repeat-frames-instead-of-discarding-the.patch'
        '0021-vorbiscomment-allow-using-vorbiscomment-parser-witho.patch'
        '0022-dca-parse-the-HD-frame-size-to-avoid-false-positive-.patch'
        '0023-avidec-remove-an-assert.patch'
        '0024-riff-add-HEVC-tags.patch'
        '0025-HACK-hevc-ignore-invalid-extradata.patch'
        '0026-h264-increase-MAX_SLICES-to-256.patch'
        '0027-vc1-wait-for-bitstream-recovery-before-starting-deco.patch'
        '0028-h264-don-t-use-deprecated-YUVJ-pixel-formats.patch'
        '0029-HACK-mov-don-t-set-the-DEFAULT-disposition-because-o.patch'
        '0030-avformat-utils-don-t-overwrite-existing-program-info.patch'
        '0031-avformat-try-harder-to-find-a-duration-of-the-media.patch'
        '0032-riff-add-ProRes-FourCCs.patch'
        '0033-hevc-port-intrinsic-SSE2-IDCT-from-OpenHEVC.patch'
        '0034-hevc-port-intra-pred-SIMD-from-OpenHEVC.patch'
        '0035-h264_parser-force-grabing-a-new-timestamp-until-a-fr.patch'
        '0036-x86-hevc-use-DECLARE_ALIGNED-for-on-stack-tmp-arrays.patch'
        '0037-hevc-scan-for-sps-pps-vps-more-aggressively.patch'
        '0038-mpeg12dec-properly-handle-a-codec_id-change.patch'
        '0039-hevc-try-to-handle-the-NoRaslOutputFlag-logic.patch'
        '0040-hevc-don-t-use-deprecated-YUVJ-pixel-formats.patch'
        '0041-hevc_parser-search-for-a-sps-pps-combination-instead.patch'
        '0042-hevc-ignore-overreads-in-the-VPS-its-not-used-in-the.patch'
        '0043-dca_parser-don-t-overwrite-the-sample-rate-it-may-no.patch'
        '0044-dca_parser-fix-parsing-of-dts-hd-header-sizes-on-hd-.patch'
        '0045-isom-Support-demuxing-more-DTS-audio-in-ISOBMFF.patch'
        '0046-Revert-avformat-mov-strengthen-some-table-allocation.patch'
        '0047-mov-Support-roll-recovery-grouping.patch'
        '0048-dirac_parser-Set-output_picture_number.patch'
        '0049-mp3-enable-packed-main_data-decoding-in-MP4.patch'
        '0050-alsdec-Fix-avoiding-reading-over-the-end-of-packet-d.patch'
        '0051-flvdec-Support-HM10.0-based-Strongene-HEVC-demuxing.patch'
        '0052-hevc-Set-chroma_sample_location-of-AVCodecContext.patch'
        '0053-h264_ps-Set-chroma_sample_location-appropriately-if-.patch'
        '0054-fix-compilation-on-msys2-mingw32-system.patch'
        '0055-configure-Change-mingw32-into-mingw.patch'
        '0056-Revert-avcodec-h264-fix-Lossless-Decoding-Profile-24.patch'
        '0057-avcodec-libvpxenc-Use-VP9E_SET_NOISE_SENSITIVITY-for.patch'
        '0058-Revert-avcodec-opusdec-switch-to-swresample.patch'
        '0059-build-Cleanup-version-scripts.patch'
        '0060-avcodec-allcodecs-Prefer-several-external-libraries-.patch'
        '0061-configure-Fix-detection-of-functions-on-mingw-w64.patch'
        '0062-libutvideodec-Fix-bits_per_raw_sample.patch'
        '0063-configure-Disable-auto-image-base.patch'
        '0064-libavcodec-libutvideo-dec-enc-Fix-compilation-with-l.patch'
        '0065-libavformat-os_support.h-Fix-multiple-redefinition-e.patch'
        '0066-ffmpeg-Don-t-show-banner-by-default.patch')
sha512sums=('SKIP'
            '553f19d3d8750d94ff211fee813f81da8c8eb3fae6254a8837dfb1bff02a00ba5892b7719505206e3027f620a12461e7e48159b8c50d3dcce07246b942d11cc8'
            '4ad3bd3a4c4962cec4475f6ec61ae301d09a748967807b5b31c87fd5d15e45aafa7d1b6bde702580f81653502f9fe2f39f68f984288c2f9625eb3f4312600751'
            '51b8d8de434c96324f67325e5a97d3419273d02c6640f9bb8114dbde8e648b14d3fae9dbf772db1b3d734bd5b4ed56ef22728d8efcfbdd0f8620c0a7c7f1f952'
            '2fa8fd6c8114e6a8a4433ce0c7fb08913cbe029a9b0ced07c187eaed1a2c10d197415f283512426e0044f58d7a262d31b67fe9288d4175e91d40873bfa8bf691'
            '9333587be6a64d4ee11c71c7e948c7354159158a11fe8ec48a03c39d67e9590cc2350e3fec0071867e480c4bce87bb2d34df0eb08c51189a2ad0c58fde75c0c9'
            '605186a4d3380326086f95d066afeada8c53f62ae7e5b505270f00ad40ee9d375521eaa9da6b5b969837b3241d16d484287256895559bca7dd999870a099bd16'
            'e87e7df5ee469c6d6ebcac6800be05f529913824a0331d7270920c73e95822cff1c0cf1c58f2c08f7820134c90091b94dbf5b9d23f51ce5e71c9b769e2067f8e'
            '47b074f34e2c04bbea55e6b4b44100c4ef6352565908da1b9987b05f6611868cd8aeed5ddc7a6f7a60f8a8358dcf7d2b8577e2491c37ee514e8e8de8779735e7'
            '9cc793b9a7d97e0d1a063f1692f82856dc6f833a149ccc1bd82aa99efe7140bea7de700050099e0fffccdddef4014d992c3fad395859e920a04249f12dd8f513'
            'e08d52d53f7592e10f87a8a7861a900fef55574d1a6d1c3ca12b3196b3549036bcb2fdc565e107d20681f965eda9e2e18f655d0ccdafab1ecd31eb5f246800fb'
            '13ff0a075a588cb5a3b3f55171434ec6d4090c3ade8c27f17c3f3b0ac402fcf166e3155b13de2c87d43c48d42da25c7fbc252996593e96e416c2d593d7355470'
            'e37dba0972567ab00356f5038200673d8f3a7f7c684b09a9fe78ff45b48bb49767a2d096637ff641db955f24e52b35f8b0d1ddd380d37045446bbad0172ab4fe'
            '0a7477b0df1b062ac86a9c18240e38e85fff1a777c3efcc0b553c77f59b044f54c7b57920e8a425e0b5478549809deb799e7da943783c9c731135e63cd68a1f6'
            '4518d6c4a9d4067b4129b7a1f80125d2bf43b561e7d5370ed472e7c7b6591118a21675f09ec494c8eaab2e3c08e2b6d574d44bd25d95b0209bb790f3fc5d2b10'
            '7abd9b13062013f260d3271da21ede0908413b6b5cc43f556251a22f21bffa89e3ce06ed849710632c157c45d3d0ebd5a07fd42e62e81174d59b733d5a20210d'
            '9089a06a4763c3bad6a4b2df3c6808a957d4ef1a045b7e28cf60362a99121fa4a104ac9bad749865fba1b60b5572ccb8354ecfd0838168207c06806b184eb777'
            '725f3395360fa139e36ab1325083235304849ab4e2d13ec7bd874f5f79da1a0e36b75b219806bb34bf3f01d5c0df3c922a3960347549cc1731ee5865208b6972'
            'e97d1f51ddc63a7a07c8b14d110e7d3a6956bd67a612c50a9fee041608afedebb17385b06ea4a7e645d9f02ccdc59b99c0f74d6301733269aa2a12de292aef2e'
            '079b95a9e8e64f33c981861976d8d09f0971d3aadaf254842a834fd445e9c07c353ed236a0a6e777e708c462150ee4287a835d905656fa7c02e3863cbde4163f'
            '2456f4026c888234a830dd67c527465a291ca2c0523eefffa6dfdf3fab8995583c9a9569b551b6f07a9dce3a94977ee03a647a17efbfa260e6819b5433a369b5'
            '88589e15f8f6e86f486efe970f1c4d463b88db4bc4300578d7327ea2531c5f543b01bd22f51df6b6c86128ad2303a1667bc8040bb0886a94c95191da286e7153'
            'a5c530ee3deb4a02960f017d45a8ccf0a01d59c8f54ebb4d5fabcc48fc74139af0da9be7ae6e6d0ce62f86efd32e5456d18d1e24a64d8062c4d7f1780a73b188'
            'd29935e9d3eb26e54e0770781c55c281dbdf1766930ec1e8576293a7daaa77e4deb72d9b31db2d4a35e361cf795a1120e7dbe08258ba37ef350afab4d1b284db'
            'f43291aece42108b2dad3f202cfc338a371f7d7aef85e11692dcc9cfb283200e657d945b54bad5bcf707022fa933cf4141d0d44eca63c73b5c5813101df18de9'
            'fed66cbd7c67fe4db5527e64388391a5fb2feb3ef5c1cc5f30f8fd26ddfa31648451599fa135882eac788e8cabfdff5651eae8dd6e43bd16811e5b0052c931d9'
            'b35e26a10fa5a8a9f8bc4807cfaa6d58f3aebc5c7443110c0d58bb678e82bf4ab518a39b5bc476d2b43f309055be8b018c4e40ed4a7fd1f325c6bf352bdc9626'
            'aa4bb5a12f347d6bbf531afe4a1fd692f4e1ea848b83dcd4d034e7fd7f98e529b5916549601d146d199978188368c7061b304b9bae929274aae779f6133a2ec4'
            'bb44faadf7c0e3be4a5cb866756a18c27384622cf6441b28022b51d6815adcf4229b3deec75551770569c8209a158932a7a0aeedbe1eabb27add5e20512ea68e'
            'a9f7be9bd32b67b70e8ee229ed040c55427fbb28b518e74423a4739eb21463c736e0e7c0843f08495095fcbcee5b0ff5b3ad38d0dbdf8a45efb5e31a0607c4e4'
            '30882755f108651d92dade808387390da1343c08235c9067e59f58b3f5e48e93ec6292f1c74a95ed820b53edc6fa72c51cf48dd957f0ac55a4f0a3984d19f4fe'
            'b736377ee137b47f543ad2f35674ae42a43e5e24adcb9585c587f17a9356449984ccb36620a919bd0a96c2753567622716bc16e975f76229dc97597a30fb77cd'
            '9465e991ab9f281c4e1ae2547062a124bcf0dcc9a8b3dbbea62e46796e704579ab7ecace264e5005ec67385de8ceb77ecc4bdad8be074eb5a9058810124360fc'
            'd63ca6e4dd7ece8b5f85b0ff199e1e282c46ac3382029fc618fa7d4522010a15e8d15bdc8075eaa0968686391e21ed7554632a26e37a87db1d3d0a3f1169260d'
            '4fe1f70a2f1f100c296a76087d32585e223444b60246b3c5bd63a8c4a5c23cfc2169c0cb8383d48d3e6ff39d06bf044f7aba5fad79d623ab0e83b86e24ae1eda'
            '5637ef55130c188942e1d67c9da8b93e79cbb31ae508a654394147d07fa8722a0bc9f320657213089f76405a093df050f707cd0aaac9b59436a87983b6b1c251'
            '7616805ace749917a6b73b763f635520ead525a609623cfd8beb80d71716b8a119e98a14c6f8186063c85e18b62da072f17711fc75d94ee44080d1aab2bf662f'
            '9e7312125da216860d2dec460fb0b091969aa68a57f180eec43ebe4487b99193c8714b6926fbbbe6ac1596432429d21bb507c6351c2d797fd2eee8abf01f446e'
            'efa88567956717da4c1384eb7fd4fe6562f3d5a2f1d9c61befafe857834ef8d86aaaa5c480fceb519802fdfdf0f7d1db300432d38e524ca4b39f73aeb21474b9'
            '926138a47bd3fbb695f5e525cd9a1874aff1a9fa662b04793eaa67fbc46173e9f73a111425ae1e66ce193e393cd6bd91c3f3ae213513a08fa706f439230263ca'
            'bcc9a3cb615ddf631cfcdf7dda821b66f9bb16d4f23ff69cbbe1385bdec6818ed7e5d3ffb096ef13030655bba4e56e1be2f7edb6fa04caaf4014d308377d14fc'
            '5db63a6fd128201c567786ee9f92324dbffc3e0c175ce926da5ca4c95115c2543111a1479eaa568d93444a892e129ab0dd820ada67fe22255e361fe293de1dc0'
            'e6a08f913f76790a7e1ec187b7f7da3b10e0da45f3c87d26892e2a41005ecfeaee708ddb3e3847c2c3b74175b558f49a934c2c4a8b3fbde65449acad5e121113'
            '588db0644856ad2009c9b0991d2d79c4d967816e13a5849a255864e6ef6ed9f372d2aec7601d8e14b3c31fbae4b789835e7ad4b74d6e1400a3b295dbfa208386'
            '9911c47ba8da7c0b3c3d97b561dd9a02d783993e38892d2f1f2210d9437d5e308183b1e806f0a4b9540dfcee353c67eb769e4f1bcf6416ec72a65edb786a3f92'
            '5249055ac436890ce0f921bcc985c94d6537eca5131d434576d20a28b7b65eef2a3f7733831108d2bae2c8b5a57984e7c9f79fb3d205261b8902eba5f3315db3'
            '42859f1e6be98f3746eda6152698ed82d413e1826ca2ac291d573fc6f9d74bd15fdaa53d26f2b9693b874747d723192888176b0c465732666e4ff86d5cf9fffd'
            'b8e902ec3728ae5c52183605ee0a6c8e26761a56542664bb901984fccd5902b7bb73c79eabbe94174fc434ebb1cab0d67a928ec71dcec901a5255acb5d835b2d'
            'b0999b50ddc5786e68c32908fad678c6a5fafd768150145928a8ff6d567f8f72f10fbc2d30887b252df32e59c4a87b2143bef5b2e168fefd8d9e9de61adf0504'
            '36692b43a7b0f4d192d8fd81b869f1ae5f01df180573339adddc7e8a2febd42816e8327f0919440f00548ab3be245d23e7eee8e0ae95f0c7dec2a22b32f7032e'
            'e5b903c3341b511be013a7cdc28cd527a28481da668c0d585f26c408bdf5c947c636c1b55e1bad32dae6299b95f58370bcd23603c940ff9784ad89546f3c1b2b'
            'f39ba6858f2dc2ade730fb173eb9a8b800a3236d695a3309e93d8d53ea73145b04789c541a66d808c24d55c3ddf0d6b4a493b5d5baccbb33aa4bbb79105dbc82'
            'fd347b5a10c261bff84b4131a575b08c4b6c567adde8830baf44b6f5c6db796688c48968291e89775ad184ddb961a7a30c4d68b92b448a5d9715f8a551a7817a'
            '09d2fcbaddc2401d6625365c1384ef9e24e76c4d59ab9803a4cc96741470d4e7b25ad96eb7b7edfd9c3091835264a83fce3fb6f3dfde59ec4f4429fd8d08f59d'
            '42a7701b3c8ba535b75701f43fad8140857fc0b3f231116ce487c4165865c6709a91978bcf6c420229b84a3ef0bf37a5658e54ba05b72c71d96fbe34167e615a'
            'fc63bdbb08f0c233f03535cf2deb811e7cb5a2a393362822a3bd75be46c3f10217505e889b4d26da5efd016fb19f611b828d453ec120c259addb847fa502fe9d'
            '58ec31a90f040a26cf1d62c53d33b9459d75fe6293fa6c47252674732b1bcac13cc5a3d86b129572ba5146eb3e598e817f6eee7f02d865a2c85775e4a90484ac'
            '400da88a098f2551ac2d1f936d784151202de5310e170f368d61a32462fda57ec47db5f5aae9f6ba006e53e1d8699c6cbadf34a7422615afa75076d94610d3aa'
            'e3c3fa80d20acb76970156499f286c78c38efa46cde4b839aac7417da6f35f81479e567b6f0b49920a87d918c51b00c84d7e3605bfea156fd10e01577cbb070d'
            'd54ff28672a2c26f2dfe12c718968d1e1dd201a067741af50e8ce7cfd12f210612bc1b6ea1796c88ab51a2e9edb4fdbe795c89ae76525a0d410dc71db2cfc78e'
            '0534ac771834799feeb386849f9082e6d5baee11b67bd2b9c29425cf83d9f026f1473df3628fd637bb7cd962db0c736f9392a11bdbc7ef0dbd938038f91089dc'
            '9db9af8162dfbddd90bf1ac07ce3b436d8de67d35a62f7023dde54353f71350b707e0131360fd253af18df8b5f092eb74b9362d943e296c3e5ecd5214818fd7b'
            '4d6ac529a8194031df9328964bdf40e55cfb68868924a52a94906b5c37ca0881762073aa51cbc7203a09e8be3ab2d59291a9ecb3156fa4bcdae1b6c53e07aa02'
            '0ed4b5d2c336563d4f4d92aabc4f18517456da99afac04f12d07e1d0cd95b45b6dbeee942973c7a2126c5329791e425c815c2ca497192e892c1a31fa35d4d2b8'
            '8fed0cf068bd330e46fefc3adee2d052bb0cea9005518b846b27cf05a4c1ea1b4a9b7e39f5a7405753ccca1645b99585a07264581090c471e4df9d4ba3b91acd'
            '9db49ed965d311d8b5e4d527a6ed1c06df023fe9a26cbca7f07b4478057b5fc360ace0d93b0b6990aee4f3bb3525da895651a71c7875df1b62b6cadff0d6052b'
            '202a98777443b2ad77f8f7a03b99c210ee79fe98bbff4d8f81cf1e583af88e92502673bdbbb4b65f4bbc14b6fe71227a11f72ec1e6bdef0f025e8343357537d0')

pkgver() {
  cd "${srcdir}"/$_realname
  local _ver=$(git describe | awk -F"-" '{ print $1}' | sed 's/n//g')
  printf "%s.%s.%s" "${_ver}" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
  cd "${srcdir}"/$_realname

  if [ -f "libavcodec/x86/hevc_idct_intrinsic.c" ]; then
    rm -f libavcodec/x86/hevc_idct_intrinsic.c
  fi
  if [ -f "libavcodec/x86/hevc_intra_intrinsic.c" ]; then
    rm -f libavcodec/x86/hevc_intra_intrinsic.c
  fi
  if [ -f "libavcodec/x86/hevcpred.h" ]; then
    rm -f libavcodec/x86/hevcpred.h
  fi
  if [ -f "compat/windows/dxva_hevc.h" ]; then
    rm -f compat/windows/dxva_hevc.h
  fi

  local -i _N=66
  local -i _i
  local _num
  msg2 'Apply patches'
  for _i in $(seq 1 ${_N})
  do
    _num=$(printf "%04d" ${_i})
    printf "\n========== patch No.%s ==========\n" $_num
    patch -p1 -i "${srcdir}"/${_num}*.patch
  done
}

build() {
  cd "${srcdir}"/$_realname

  if [ "${MINGW_CARCH}" = "x86_64" ]; then
    PATH=${PATH}:$VC64_DIR
  else
    PATH=${PATH}:$VC32_DIR
  fi
  export PATH

  if [ -f "${MINGW_LOCAL_PREFIX}/include/nvEncodeAPI.h" ]; then
    local _nvenc='--enable-nvenc --enable-nonfree'
  else
    local _nvenc=''
  fi

  ./configure \
    --prefix=$MINGW_LOCAL_PREFIX \
    --enable-gpl \
    --enable-version3 \
    --disable-static \
    --enable-shared \
    --enable-gray \
    --enable-avresample \
    --disable-pthreads \
    --enable-avisynth \
    --enable-libdcadec \
    --enable-libmfx \
    --enable-libopencore-amrnb \
    --enable-libopencore-amrwb \
    --enable-libopenh264 \
    --enable-libopenjpeg \
    --enable-libopus \
    --enable-libspeex \
    --enable-libutvideo \
    --enable-libvorbis \
    --enable-libvpx \
    --enable-libx264 \
    --enable-libx265 \
    $_nvenc \
    --enable-opencl \
    --enable-opengl \
    --arch=${MINGW_CARCH/i6/x} \
    --cpu=sandybridge \
    --extra-ldflags="${LDFLAGS}" \
    --optflags="${CFLAGS} ${CPPFLAGS}" \
    --disable-symver \
    --sws-max-filter-size=512 \
    --disable-debug

  make clean
  make $MAKEFLAGS V=1
}

package() {
  cd "${srcdir}"/$_realname
  make DESTDIR="${pkgdir}" install install-man V=1
}
