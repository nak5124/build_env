# Maintainer: Yuta Nakai <nak5124@live.jp>

_realname=ffmpeg
pkgbase=mingw-w64-$_realname
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}-git"
pkgdesc='Complete and free Internet live audio and video broadcasting solution (mingw-w64)'
pkgver=2.8.74815.3cf0c95
pkgrel=1
arch=('any')
url='http://ffmpeg.org/'
license=('GPL' 'nonfree')
provides=("${MINGW_PACKAGE_PREFIX}-${_realname}")
conflicts=("${MINGW_PACKAGE_PREFIX}-${_realname}")
makedepends=('git'
             'pkgconf'
             "${MINGW_PACKAGE_PREFIX}-mfx_dispatch"
             "${MINGW_PACKAGE_PREFIX}-opencl")
depends=("${MINGW_PACKAGE_PREFIX}-SDL"
         "${MINGW_PACKAGE_PREFIX}-bzip2"
         "${MINGW_PACKAGE_PREFIX}-dcadec"
         "${MINGW_PACKAGE_PREFIX}-liblzma"
         "${MINGW_PACKAGE_PREFIX}-libutvideo"
         "${MINGW_PACKAGE_PREFIX}-libvorbis-aotuv"
         "${MINGW_PACKAGE_PREFIX}-libvpx"
         "${MINGW_PACKAGE_PREFIX}-opencore-amr"
         "${MINGW_PACKAGE_PREFIX}-openh264"
         "${MINGW_PACKAGE_PREFIX}-openmj2"
         "${MINGW_PACKAGE_PREFIX}-opus"
         "${MINGW_PACKAGE_PREFIX}-speex"
         "${MINGW_PACKAGE_PREFIX}-toolchain"
         "${MINGW_PACKAGE_PREFIX}-x264-10bit"
         "${MINGW_PACKAGE_PREFIX}-x265-hg")
source=("${_realname}"::'git://source.ffmpeg.org/ffmpeg.git'
        '0001-get-accurate-estimate-from-the-PTSes.patch'
        '0002-HACK-Disable-tb_unreliable-preserve-original-fps-inf.patch'
        '0003-aacdec-construct-extradata-if-it-wasn-t-present-befo.patch'
        '0004-Increase-the-maximum-probe-size-to-4MB.patch'
        '0005-prores-set-avtx-pix_fmt-based-on-the-fourcc-code-dur.patch'
        '0006-Silently-error-out-when-pos_limit-exceeds-pos_max-in.patch'
        '0007-mpegts-switch-back-to-mpegts_get_pcr.patch'
        '0008-file-increase-io-buffer-for-better-performance-on-hi.patch'
        '0009-mpegvideo-null-out-current_picture_ptr-when-allocati.patch'
        '0010-h264-flag-interlaced-coded-frames-as-such-when-sei_p.patch'
        '0011-HACK-preserve-mpeg2-END_OF_SEQ-code-to-the-start-of-.patch'
        '0012-HACK-mov-when-seeking-secondary-streams-don-t-insist.patch'
        '0013-aac-7.1-should-have-side-channels-and-not-2-pairs-of.patch'
        '0014-Revert-mpegts-clear-avprograms-only-for-removed-prog.patch'
        '0015-HACK-avio-add-a-flag-to-skip-the-fstat-on-file-openi.patch'
        '0016-flac-export-vorbiscomment-metadata-in-extradata.patch'
        '0017-swscale-make-sws_getCachedContext-properly-handle-pr.patch'
        '0018-h264-set-h-sps-if-none-is-set-yet.patch'
        '0019-riff-don-t-try-to-parse-too-small-WAVEFORMAT-headers.patch'
        '0020-Fraps-output-repeat-frames-instead-of-discarding-the.patch'
        '0021-vorbiscomment-allow-using-vorbiscomment-parser-witho.patch'
        '0022-dca-parse-the-HD-frame-size-to-avoid-false-positive-.patch'
        '0023-avidec-remove-an-assert.patch'
        '0024-riff-add-HEVC-tags.patch'
        '0025-HACK-hevc-ignore-invalid-extradata.patch'
        '0026-h264-increase-MAX_SLICES-to-256.patch'
        '0027-vc1-wait-for-bitstream-recovery-before-starting-deco.patch'
        '0028-h264-don-t-use-deprecated-YUVJ-pixel-formats.patch'
        '0029-HACK-mov-don-t-set-the-DEFAULT-disposition-because-o.patch'
        '0030-avformat-utils-don-t-overwrite-existing-program-info.patch'
        '0031-avformat-try-harder-to-find-a-duration-of-the-media.patch'
        '0032-riff-add-ProRes-FourCCs.patch'
        '0033-hevc-port-intrinsic-SSE2-IDCT-from-OpenHEVC.patch'
        '0034-hevc-port-intra-pred-SIMD-from-OpenHEVC.patch'
        '0035-h264_parser-force-grabing-a-new-timestamp-until-a-fr.patch'
        '0036-x86-hevc-use-DECLARE_ALIGNED-for-on-stack-tmp-arrays.patch'
        '0037-mpeg12dec-properly-handle-a-codec_id-change.patch'
        '0038-hevc-try-to-handle-the-NoRaslOutputFlag-logic.patch'
        '0039-hevc-don-t-use-deprecated-YUVJ-pixel-formats.patch'
        '0040-dca_parser-don-t-overwrite-the-sample-rate-it-may-no.patch'
        '0041-dca_parser-fix-parsing-of-dts-hd-header-sizes-on-hd-.patch'
        '0042-isom-Support-demuxing-more-DTS-audio-in-ISOBMFF.patch'
        '0043-Revert-avformat-mov-strengthen-some-table-allocation.patch'
        '0044-mov-Support-roll-recovery-grouping.patch'
        '0045-dirac_parser-Set-output_picture_number.patch'
        '0046-alsdec-Fix-avoiding-reading-over-the-end-of-packet-d.patch'
        '0047-flvdec-Support-HM10.0-based-Strongene-HEVC-demuxing.patch'
        '0048-hevc-Set-chroma_sample_location-of-AVCodecContext.patch'
        '0049-h264_ps-Set-chroma_sample_location-appropriately-if-.patch'
        '0050-fix-compilation-on-msys2-mingw32-system.patch'
        '0051-configure-Change-mingw32-into-mingw.patch'
        '0052-Revert-avcodec-h264-fix-Lossless-Decoding-Profile-24.patch'
        '0053-avcodec-libvpxenc-Use-VP9E_SET_NOISE_SENSITIVITY-for.patch'
        '0054-Revert-avcodec-opusdec-switch-to-swresample.patch'
        '0055-build-Cleanup-version-scripts.patch'
        '0056-avcodec-allcodecs-Prefer-several-external-libraries-.patch'
        '0057-configure-Fix-detection-of-functions-on-mingw-w64.patch'
        '0058-libutvideodec-Fix-bits_per_raw_sample.patch'
        '0059-configure-Disable-auto-image-base.patch'
        '0060-libavcodec-libutvideo-dec-enc-Fix-compilation-with-l.patch'
        '0061-libavformat-os_support.h-Fix-multiple-redefinition-e.patch'
        '0062-ffmpeg-Don-t-show-banner-by-default.patch'
        '0063-asfdec-Prefer-asfdec_o-over-asfdec_f.patch')
sha512sums=('SKIP'
            '429c2b0885beb93e60555cdd003d5f2d82c2e08bcf7ec2cee20c4649e0e568b22c2875c8f177c0569fddd31319c0d52f979767f41fe50dd541418c213f10fd31'
            'e30ca17e9de71413c634623dae63a70424d71f5abc816e34e583b232e152268f44d2eb079531e0dca80daf0a0d93f21eed4d8fa60f6dd3047c54550d66eff51d'
            '4832914b591192ade8370afe9faea20b4d1e62b40edd84fb7af829e6dab8277d57638e7242c6a2c5ad6012297f523f50e48cab977f3fc63d4e99e72df996eb7f'
            '5123a5c88df4879a1998fce0706601e14ca55464fd72db2c9951f2a86bf890e0005708f241707a647166d4b423e7b7f1b0360636f5427c2cb06f9e03863db5ce'
            '4a85dfd42d5eb4162d70fe259bbb634c8f345036146c80a6f72bc6c3ece7194cea054eaf0645b51ce485a8b76cf4e3ccfa32fa9332d2a15581fd1501b092b286'
            'f1b3cd5c5c64b38374b87f8fca48fe16b841d0a6f1aae7306e6e9f258c8d445939657ad862e4d931484558607c5b084cd8a2b4f8d43f3263007c0ff088842e3d'
            '207ea340ad4b38ad663f11b9690386bbfbf27f66236c56ec48bc8d0c7185c45b77bee3cf02880376b28d04eb8844c3118c570e767a87eea8986193eb1a21f050'
            'e177e3e2c256f85ec2032c1f346432e3f1e5e9a767350f8d3dedc1468413fe2c3d8eb19d400a9fda3612416fd2d0cef42b573c3d4a3a14023f243afcbefc5b6b'
            '12542e31c1fce94e8cb02beb657bb46ffc73a348375aa64ed9b6b7615e6402df4b9bc56694f82a3dabe462b49ca5d0c5f84b2d9545028b435696edbaa01358e6'
            'db0576747a4c212ab0ec881cf5fff472884b58e1ebac3c6552930303f831e8fa517cbbac7cb1c7e5036caeed398c530f43f38515717682a4174d2359c08c9117'
            '1a1a1abfde7ee0d8758a1e36f8fe262532bf3840a7b7010fc698216fbe913347e3bda232e07ea7eda2e5c1262766ca9669622896056231418420c8375ffc6dce'
            'd01c3028a9ff8250593dc0573fd236bbf64be82e72e168bbb09d6a5aa334749b9f75c731c470ede3a0c361b8a7216dd6f62da107f556f5111c60f3b6961c4750'
            'f2140d1fad165d89ffce6025adbd84a2d6a2b0ebba04f16efdf6efa95d276b21643936f04893ed15e61720f09e64c7b8a3f3afa07ac81cfd3857a2363a9e541e'
            'ae3ec78f1d8c01dea4892539478e0be275da6ec5de5e1fa66f91dd2da644fbbb6f0cdf985d5397d2e84d829d6b7069ad55491c2fd160998f9a30bc5d3f137e5a'
            'aae22d5a44f9732d282f14f04cb4e50832eac796da843d48368c06e03877a8d5c89e8aaad0e6e887680b0ab852da2cd3b95930d98c7246890d623c6b93ec5eae'
            '4d57e6ca42aabd08910fb081dee94f988b58d6cce12f56c36816518179cdbbd285bc390e39d0a221e08b470c65e166d6452e5d78abdb3f6cfffddbb4eb710e34'
            '784127f5c4ddfcbaa11b5085766f9442c90c239fea54c5daf4a98bb11703bede8abd82e12fddf3b2ee30c747741822b60fe529506ea12ddf52a47920355b1f3a'
            'b3d0d262d205320b3aa95e2892535fccc14a13376c1e332b54061313eacfb5a1c0d6739e00ff1fbc0442be3fb5ac168f3767f144572685746e67fefe06576d1a'
            'dc86ed69d44ecf87c88c9535e5467cfb5aafda1ec5f00a06149f59b742dbf1cc32c8b92647026e9b09130af182f9d9ec1322987d7eee90d4ce9d658e7f6962f0'
            '4e36cf4bb2ad32e167587ef7a4d0a2cb58c46021a00d298668aa3fcf2f227144b570f2ce37e1926aca04ab2e2b8da0bc0ff86b7011c10c35290271170d46c6aa'
            'e6a8ff192833c0ae327c9f398a843a09dfc4e97524ebabc3cc38b63d92df0093e14c395b0869bd4214ddc57fc3114340f362a14100de3ba5e1ce6ccdaeb68679'
            'f2b3e9b9c8aee34351639300e775c4afbf8a845d3ae733141adb6ef4834da87aee7ffed477b1bf0571f8c4ca2d24f2e8adf82be11bb3ce15ccdb5ab6dba35b7b'
            '13e2d97bfa86a4035859941cc2f43ab43272def960fe2a4709aafb815bd395d2c4b10a21485f0fbc1c41ea1de87215ea874ffbdf4f1d03cc33286ef8bf2f3146'
            '933b55dee9aa7d1678396617da1d5ca0015c1d4d47dee693052309a9c669b3f28327b7e6b4dd39d9e8c3993e5b2e98a65328c8e70aa154ec4e41e1cfeac1df9b'
            '9f250f21a500979e2f982bb394c4745c9d2ed6add42cbcbc2b25acf266542d12b9c6b50bf81fe7131ed120beb10bbb51daf31796b4b1ed748f218eb5adaf92aa'
            '89b91f6ed5a901c2b58980b6828247b145c984c26afe13fe7a8946ce7b4f562893238c792d5cee28a4419210b945d6a898861ce0f0e67ed74fb2442bb097dd66'
            '82a138640ca4855b0ebebf32acfc9199764fec27bc656c5fb094982ca0c0081366b952fb3f52255a041b9d3e30cea6abbd735d84fd1b55a0bf2d126ea198e3ec'
            '0f03c27269fadcc003cb903d80e9a5de9df7ceaa8bac6999904b980f525d89166d454fc33f8ee9038e073fed9e9829959c3eb24e7b3b2b740b706cd7d35e6eef'
            '458522283977415ab5c9be95499c055a9d746bed1cf1fceec818a32134589e1a78facb013fc6a6d944c37e6b7d821608c903df9550e182dcb594025b10577cb4'
            'cb277536b0e3c338285b3d63e06d5a6672487c0338d4156cb9b13aa6ca54626ba87bf65251a7ce6f3c1735374b769d39c6e07c870361af57a837b80356d508a9'
            'ba4766f5c9a2f9a402711b09704e504cfd484aa89b1103a97aa0debcfca5e0b9cca2faee455cba934df726872b8af5dc97f6f11968de47f22df9bc7203f1b952'
            'f8ec7edc9be6e138b2568005a37f56d4377bea661000f93e1d1aefd8c99d68959068d3042c118dc285af87c6708ec9f98a0ac7005b3112fcfa6b5370a3e4b682'
            'e005845c9c5310c5077a654999c8a4d262dc4c70992d90a2f9ae83185015240ae452736c3e0727ea4d0dbb4f08f57585aa5dfe62537146161a39738ccab8e0d0'
            '8bdfcb8c3893491f87bb34d9e0ff753b77c0180ee85c97ba34cd745b97c5e969397721ba84ea51b40a3f0c33446dccb30685481b9308baac691aec668b7dfb8a'
            '671db0ad72ddd8af9f55335ecbb906db84c69574803c4a2880d4fac74f82638e4560d9ba848d81a8384da8b4ce1d29399239e39f6853ec7ec6e04ca604b415cb'
            '8e4ca2a6bd6960ec973249d10b1b411114b93c26f0e9dd1499fe6bae72ca5b6cfb312d5bf5ef662b50034d4c1b7d75e9f9f0b4ceb20f8a56d935bfdcb803ecb9'
            '59a925712311cbe8baf15600ae8f43bec3c6d461be5c0d438e60bcabf215e9570789682de2838b90b7af5d9a7fe27eb184240dab6969a39424d3f305c8c4dd21'
            'fc9db842e5c9e8bdfccdc69777c0fdd030c32ef583f48597bc533b815c6730fbc477f7c02523dda3dd3755645e0a5f7177d96b1b42a8cf3ba98ab5b3f296c84e'
            '884e2107c0b0279f18486b6c6d336578ba5a34cb832307e97ce57a49298f536de660d2dff89b5e82b4ba5335f67916aaeb0baaebc572e927a8dee3f9f4251b27'
            '706c1b97b58a825abd2d90928f0fd443447d3fbfbf2d5ee0720ef68f11ec0527ec794682938a2741e0ff5bc45b8a2d2e1c78f71b7bb105994742d8982c7706db'
            '76e0620dab75c028bf12881c170b41c05656f739f183d5cddbb3b505ba0a12cddcf862fbc3efdd58a771712294cb514785bd7af4cef3bd47e4d1b06560c17f50'
            '5f8a6abbdf9610bb9bfe7a6447ac277876d7b29c407df208c3d08c6132827ab98acdd1864bfe80738a53ed92066351a86f8c81a0d5e19a4bdee185b8d39afd2d'
            '79511c8ca1ea8b461bab62ed612d3bdf9fea8cdba6fc97a7700df4e7a843b4354f5b8a67e8e2838f528ac845f35683b652d8b503e33f3daff5307bad924ccc6c'
            '02cce389a41905589794360161fee16d4aaa7345ef528276f436159a6c3c51ae2bac112e44205d846fd9db2661e3c59051ed5015b2d536274b9a89b6c8904857'
            'f207c340ecb26344631fa82d4f50321ac30c6de437459de4400df1c3c8758e1b0f24ef977b0fc84d4c91d2e4d7dca82a3c9395ff52bd4e3805415d988c6e65d0'
            '83ad544ae8911f0d04771e1729c92f75c0ba743872fde5457f7e28f065664f8415b842e836e6ddd963f18da7f794d0ad6492640ec2062f454084a36a4653f699'
            'c17671000ab6284b5c8f78baf665aa02d844e4f9e2346dabd6af200ef14b3f2d3e63d551d2a297fb178360a8dab17f741d9a9bc604ac2d6795add4e2780b0d33'
            'f9eef388466344da4daae11e11506f5314286cd9c735fbcce3b412f0e12980488b5cc42c2f3b41c5720e9796e2546da1f2dcb7c8c2f5e54fdcdf803bd1029cb4'
            '2335b1fbd267f1a8e7b42fcd6cbe3524ac851dccd22011ee978ccb47f3887f7568e58d41c898add73b531a0c3521638e2de3233f863e1654ce5439423d5e5db7'
            '0784d12253040915c625e0be395fe1f21211c12dd204689dad52d80e1b13725e2cb5ed91c5515f0862412fdfa952976178186144e6d5415de13bdd90657bb22b'
            '17049331ff5af6eb197ea9574c019a98a52821b8b6ee791857a3102f21374b8fa51c8ec58bfca2096fc458f7b04b68b8385855f0118bfafbbc8e15ce039ef1c2'
            '153a9ae580e22d640a360dbff0d4cff42dbdd1b5103d069c0e72f93377ec27051598a961a8f7497c6f38fd0b22511b53a2ef47646cec3c9911483866c2540672'
            '72b27534da671e3581a44a6cc2d7d3fd47906864b418074417f0094f23e54b3cec526b96e59616420038357bac51d11ba81daf24f6a27bff58d776307b563197'
            'eb4a2f4d112395b38822343aa3f100bb721acbb501a6fb239ea347cb03d0408ee96e8fba276669b92a1e8f27ab621f45138fd698223e20d8357f1940d6b68998'
            'fa926a5ee7822507fc42fef7f0dd0d666f34e48a8e30d895d18fac562295ded9505473cd786396d645e7690c7bfe98b15c6c0bebab725fd07c4d9331d2b90ae5'
            'c0b382da4da009ac6c48b96d9073164774aea31e2150109e21033ac090562aecd7921e87666d4afa8d8b7de660905dcac53bc60c26195fdfed821e852a9f63a5'
            '2a14659c1af359f924bcb7e72eb8f7d59314fbe16182a464796991af8646d5d0c845ac5515f5fffffc1fb474c6c40f5a808fc181ac2d0fc30894002c960b8855'
            '2fec95bd5abb0d6a50b7c0b87438c0172ae7f2e30ecd25018e46aba3f20eeb569541703ccd31bbf7bb9b026fe5273c39f0c79761b454357818be074994c2ce05'
            '85d2e627a60378164c0798c487fd509612e7c2b211365fbe7d8b9b226fa1ac78b147076d7b5d5a7e47d7284aa7c5c27ddc72d437bdd510b0d30166bbe00319ea'
            '9afb58f0576dc7f478689d790043106973bc79a774aced49c24c38b2eaa7d54c540274c0094449c0da588f03092ec552bc7d7b22c32c452d295b61524758a917'
            '24f9b8f3d72a919dd72eca301e7e154f51ac1b16373f6f27cdae387908cbb0756132ffe30608fde8e16d2f5bafb4838f2f2df3624c519fe2f8418c349e5f8aa5'
            'ca95ba791215b11180f3106b1b01f532ba4f05b28a79ba4d958117c2d3669e2032ddd0ad86e24a8422305df3f53763b1c4196c5d6770ea5a7d58543e639f09f7'
            'ad4f4cd6dac0c1b90741a42704280dbceffff1ca4e1acf8481c67ce6223053bb0cf9d2cfbd3213615f4d82373c6acc224eb5ab6cd7891bec3ec5275c81bdc185')

pkgver() {
  cd "${srcdir}"/$_realname
  local _ver=$(git describe | awk -F"-" '{ print $1}' | sed 's/n//g')
  printf "%s.%s.%s" "${_ver}" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
  cd "${srcdir}"/$_realname

  if [ -f "libavcodec/x86/hevc_idct_intrinsic.c" ]; then
    rm -f libavcodec/x86/hevc_idct_intrinsic.c
  fi
  if [ -f "libavcodec/x86/hevc_intra_intrinsic.c" ]; then
    rm -f libavcodec/x86/hevc_intra_intrinsic.c
  fi
  if [ -f "libavcodec/x86/hevcpred.h" ]; then
    rm -f libavcodec/x86/hevcpred.h
  fi
  if [ -f "compat/windows/dxva_hevc.h" ]; then
    rm -f compat/windows/dxva_hevc.h
  fi

  local -i _N=63
  local -i _i
  local _num
  msg2 'Apply patches'
  for _i in $(seq 1 ${_N})
  do
    _num=$(printf "%04d" ${_i})
    printf "\n========== patch No.%s ==========\n" $_num
    patch -p1 -i "${srcdir}"/${_num}*.patch
  done
}

build() {
  cd "${srcdir}"/$_realname

  if [ "${MINGW_CARCH}" = "x86_64" ]; then
    PATH=${PATH}:$VC64_DIR
  else
    PATH=${PATH}:$VC32_DIR
  fi
  export PATH

  if [ -f "${MINGW_LOCAL_PREFIX}/include/nvEncodeAPI.h" ]; then
    local _nvenc='--enable-nvenc --enable-nonfree'
  else
    local _nvenc=''
  fi

  ./configure \
    --prefix=$MINGW_LOCAL_PREFIX \
    --enable-gpl \
    --enable-version3 \
    --disable-static \
    --enable-shared \
    --enable-gray \
    --enable-avresample \
    --disable-pthreads \
    --enable-avisynth \
    --enable-libdcadec \
    --enable-libmfx \
    --enable-libopencore-amrnb \
    --enable-libopencore-amrwb \
    --enable-libopenh264 \
    --enable-libopenjpeg \
    --enable-libopus \
    --enable-libspeex \
    --enable-libutvideo \
    --enable-libvorbis \
    --enable-libvpx \
    --enable-libx264 \
    --enable-libx265 \
    $_nvenc \
    --enable-opencl \
    --enable-opengl \
    --arch=${MINGW_CARCH/i6/x} \
    --cpu=sandybridge \
    --extra-ldflags="${LDFLAGS}" \
    --optflags="${CFLAGS} ${CPPFLAGS}" \
    --disable-symver \
    --sws-max-filter-size=512 \
    --disable-debug

  make clean
  make $MAKEFLAGS V=1
}

package() {
  cd "${srcdir}"/$_realname
  make DESTDIR="${pkgdir}" install install-man V=1
}
