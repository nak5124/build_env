# Maintainer: Yuta Nakai <nak5124@live.jp>

_realname=ffmpeg
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}-git"
pkgdesc='Complete and free Internet live audio and video broadcasting solution (mingw-w64)'
pkgver=2.7.72901.178ba1f
pkgrel=1
arch=('any')
url='http://ffmpeg.org/'
license=('GPL' 'nonfree')
makedepends=('git'
             'pkgconf'
             "${MINGW_PACKAGE_PREFIX}-mfx_dispatch-git"
             "${MINGW_PACKAGE_PREFIX}-opencl")
depends=("${MINGW_PACKAGE_PREFIX}-SDL"
         "${MINGW_PACKAGE_PREFIX}-bzip2"
         "${MINGW_PACKAGE_PREFIX}-dcadec-git"
         "${MINGW_PACKAGE_PREFIX}-liblzma-git"
         "${MINGW_PACKAGE_PREFIX}-libutvideo-git"
         "${MINGW_PACKAGE_PREFIX}-libvorbis-aotuv"
         "${MINGW_PACKAGE_PREFIX}-libvpx-git"
         "${MINGW_PACKAGE_PREFIX}-opencore-amr-git"
         "${MINGW_PACKAGE_PREFIX}-openh264-git"
         "${MINGW_PACKAGE_PREFIX}-openmj2-svn"
         "${MINGW_PACKAGE_PREFIX}-opus-git"
         "${MINGW_PACKAGE_PREFIX}-speex-git"
         "${MINGW_PACKAGE_PREFIX}-toolchain"
         "${MINGW_PACKAGE_PREFIX}-x264-10bit-git"
         "${MINGW_PACKAGE_PREFIX}-x265-10bit-hg")
source=("${_realname}"::'git://source.ffmpeg.org/ffmpeg.git'
        '0001-get-accurate-estimate-from-the-PTSes.patch'
        '0002-HACK-Disable-tb_unreliable-preserve-original-fps-inf.patch'
        '0003-aacdec-construct-extradata-if-it-wasn-t-present-befo.patch'
        '0004-Increase-the-maximum-probe-size-to-4MB.patch'
        '0005-prores-set-avtx-pix_fmt-based-on-the-fourcc-code-dur.patch'
        '0006-Silently-error-out-when-pos_limit-exceeds-pos_max-in.patch'
        '0007-mpegts-switch-back-to-mpegts_get_pcr.patch'
        '0008-file-increase-io-buffer-for-better-performance-on-hi.patch'
        '0009-mpegvideo-null-out-current_picture_ptr-when-allocati.patch'
        '0010-h264-flag-interlaced-coded-frames-as-such-when-sei_p.patch'
        '0011-HACK-preserve-mpeg2-END_OF_SEQ-code-to-the-start-of-.patch'
        '0012-HACK-mov-when-seeking-secondary-streams-don-t-insist.patch'
        '0013-aac-7.1-should-have-side-channels-and-not-2-pairs-of.patch'
        '0014-Revert-mpegts-clear-avprograms-only-for-removed-prog.patch'
        '0015-HACK-avio-add-a-flag-to-skip-the-fstat-on-file-openi.patch'
        '0016-flac-export-vorbiscomment-metadata-in-extradata.patch'
        '0017-swscale-make-sws_getCachedContext-properly-handle-pr.patch'
        '0018-h264-set-h-sps-if-none-is-set-yet.patch'
        '0019-riff-don-t-try-to-parse-too-small-WAVEFORMAT-headers.patch'
        '0020-Fraps-output-repeat-frames-instead-of-discarding-the.patch'
        '0021-vorbiscomment-allow-using-vorbiscomment-parser-witho.patch'
        '0022-dca-parse-the-HD-frame-size-to-avoid-false-positive-.patch'
        '0023-avidec-remove-an-assert.patch'
        '0024-riff-add-HEVC-tags.patch'
        '0025-HACK-hevc-ignore-invalid-extradata.patch'
        '0026-h264-increase-MAX_SLICES-to-256.patch'
        '0027-vc1-wait-for-bitstream-recovery-before-starting-deco.patch'
        '0028-h264-don-t-use-deprecated-YUVJ-pixel-formats.patch'
        '0029-HACK-mov-don-t-set-the-DEFAULT-disposition-because-o.patch'
        '0030-avformat-utils-don-t-overwrite-existing-program-info.patch'
        '0031-avformat-try-harder-to-find-a-duration-of-the-media.patch'
        '0032-riff-add-ProRes-FourCCs.patch'
        '0033-hevc-port-intrinsic-SSE2-IDCT-from-OpenHEVC.patch'
        '0034-hevc-port-intra-pred-SIMD-from-OpenHEVC.patch'
        '0035-h264_parser-force-grabing-a-new-timestamp-until-a-fr.patch'
        '0036-x86-hevc-use-DECLARE_ALIGNED-for-on-stack-tmp-arrays.patch'
        '0037-hevc-scan-for-sps-pps-vps-more-aggressively.patch'
        '0038-mpeg12dec-properly-handle-a-codec_id-change.patch'
        '0039-hevc-try-to-handle-the-NoRaslOutputFlag-logic.patch'
        '0040-hevc-don-t-use-deprecated-YUVJ-pixel-formats.patch'
        '0041-hevc_parser-search-for-a-sps-pps-combination-instead.patch'
        '0042-hevc-ignore-overreads-in-the-VPS-its-not-used-in-the.patch'
        '0043-dca_parser-don-t-overwrite-the-sample-rate-it-may-no.patch'
        '0044-dca_parser-fix-parsing-of-dts-hd-header-sizes-on-hd-.patch'
        '0045-isom-Support-demuxing-more-DTS-audio-in-ISOBMFF.patch'
        '0046-Revert-avformat-mov-strengthen-some-table-allocation.patch'
        '0047-mov-Support-roll-recovery-grouping.patch'
        '0048-dirac_parser-Set-output_picture_number.patch'
        '0049-mp3-enable-packed-main_data-decoding-in-MP4.patch'
        '0050-alsdec-Fix-avoiding-reading-over-the-end-of-packet-d.patch'
        '0051-flvdec-Support-HM10.0-based-Strongene-HEVC-demuxing.patch'
        '0052-hevc-Set-chroma_sample_location-of-AVCodecContext.patch'
        '0053-h264_ps-Set-chroma_sample_location-appropriately-if-.patch'
        '0054-fix-compilation-on-msys2-mingw32-system.patch'
        '0055-configure-Change-mingw32-into-mingw.patch'
        '0056-Revert-avcodec-h264-fix-Lossless-Decoding-Profile-24.patch'
        '0057-avcodec-libvpxenc-Use-VP9E_SET_NOISE_SENSITIVITY-for.patch'
        '0058-Revert-avcodec-opusdec-switch-to-swresample.patch'
        '0059-build-Cleanup-version-scripts.patch'
        '0060-avcodec-allcodecs-Prefer-several-external-libraries-.patch'
        '0061-configure-Fix-detection-of-functions-on-mingw-w64.patch'
        '0062-libutvideodec-Fix-bits_per_raw_sample.patch'
        '0063-configure-Disable-auto-image-base.patch'
        '0064-libavcodec-libutvideo-dec-enc-Fix-compilation-with-l.patch'
        '0065-libavformat-os_support.h-Fix-multiple-redefinition-e.patch'
        '0066-ffmpeg-Don-t-show-banner-by-default.patch')
sha512sums=('SKIP'
            'cb9b76a7216e70a633f91fc991db80c9548dffab15692feea3dd38a857daa8047ebf4804ae0a7ef0babcc484ad42430deea096fd7564e84fc6a67ab26e584600'
            '198f33b6c47c738db40dbd1cf0759e0a8a6ccaa3cf7abeb88f62eca6a096bd655eaf3e5bd61456d6a811df7ec0f7dcda460bbe9cf1e34ca0d558c7c95c3f8695'
            '0629ceb441ef207d1c18eb9486bbb05c1cbfe2d0911a4e6c1779ec841a8120322a518386a9ad748ce7b240ecb4a3f5ea92a6f8dbc6e1fa366d19fbc6405b5bd4'
            'b66ca806a01850ae2b06ccd325300ec48030c3d611634a0f53b2a2f3af71cc7c37f1f6c1e3a45495d44b7bbd32700338821d01ab8f791a8eeed876a58bda7afb'
            'b05330e74aa3e9492db5abb4be7e4470b2905c45228a33a350669f1203b714fe6db986d4a3dfdb6106283598df5e4afac98551771fe68fd07dc6b3d90d1e3a02'
            '6c461a387e19986af0d94b69d4fe2773c5cdec870706e861f0dca78d3c392f2c0119eb520c63490204c5e06848080254b8a7c1163865b0617608e44c648c57f8'
            '5244063ba784fcf1738f5d02d21c6214df54e58f61bb37c3926954e8fcb2d42ee8bfa521c493f4174a606e6bb3b68656e291d191a50d3c3bdb20eeb5a3b8a4e2'
            '67b1ab6736714156b20b1f70a498177cecd01f5aa66956d7ef6ef5ae09ab0fa55be2fac69fceaefa770717c7812883ea3a33cd1d3f833f00ca5236bbb326386a'
            '492a87080ad75d2d69992d9fd7b1f011cf357a73dbd4e5dad7e09f8381972e2a97699f8f45586c41d66fa9dca986459f1ad86f012bbf0ede68c940ef35c33e3e'
            '1459a90c81f2501dc0e45060c79c87dc007ceb78438097f4a06b282388237278ca904a6d33539fe0502af2e95d03d7d59591c658875c485a1884dbdff5de3acd'
            'f35bac80b8b46ea097c11e0f21277db4ffe9c2f26c7d18656d84ec13ebb7c91947eb3d0d862c3aba444f3704272a84ffc602218dbdece887773226e6c699b68b'
            '00c784ad0c001290d4616e2024bc576e43d4d71308f7c163e5e785970934dce469c0036a4db0f1f0932e7df4e1552858a74f492a9a800f82050220525f4b9116'
            '010c3c56677972ad68abaef36a88ef6340270c686b16c4458aa5bace1f4b6f2b951091f68fc83a893a0f93821013ed133d5bf2b9d67ba3fe9c241b5dd3d1b4dd'
            'd52e23ee219e6a50099b5bcfedf995202233bf1c8e1902653d5f0ee250b747b59f5af2356bb9148681e6ce336cc21fd99bd2259910b983a46c21b90d1615e0b0'
            'c860c2bc5029e491e9f8dc3533b8b5a88191e4a8f2a3bf966b966a6f7c4266ab4b8dee9d51e28082cb66608fdab55df3b261f669428f3198453b62ea70b9240d'
            'b43595f582b86c3db475b467bf52ad0d24e7d9e56ffe9e26ceccea5c244897ec549d6f1f922260f999a62956c03059b74f04fb11ee2c7313838d8cc78e888eaf'
            '03b1dad5ebe3b0036c528af3309e1bbfc5303a42e1d71c65c35e3992eb2c6c68db43e9743b9427689e07152f0d4313ebb016ee0d926e1c6294afdb9c06e809c7'
            '1fd24607f753f42b42d6de96df5e97678cc0b773331e0b590be0d2f7a36839b40eb5f285ecdffe21d96ae6f4a45e50795155812c5c186216dcf82ef2ff0fae55'
            'e15f49b3302fc1d4aa973a49511209b3566d9990adcc7e150514113fa95df90a013a988d97df14c35592c563e882092bfcb0928b19188c9ce31589a8b212d72a'
            'a2a9d118908fcbdd91b85676ac025b3e0d926cae88edf65941a1215be33d611a2e59aec72c33d229a29b3a067603cb80fc64db61a2ed7fff8c52aae050bbd18d'
            '34252eb27432b0aaa9392ab4a330cf5f9ce3ae1e4e7c137718b2246d68f1ae0d94b28f387bf9e37a840e521a7af6d3b21e06e75ea35c436508dda69bf519ae2a'
            '93b813f76a77f68091f7b4df39787e7c7b8636d74fd0093e7be401a0e7c3969467d4167548552f402ce789999de03edc120db6bf8e7759949a4ac11e2e546363'
            '787487c47299eac900f3e93540354bb0deed5e41687aa05918d622b5344f54328c0ebd412bcca07310133bf2f63acb40aca3023a6ad6d4176fd5748e081f17f8'
            '8a24ee627aa2429f535833ab4a487fd86c7202416426e62b1c4b937694ec82094aa6a2f39e92ec6d79a85ac6e6b61183bc0fe646352116bb004b64bb281bb5ae'
            '5c9f02303fb56f98219b3dfc994a2633c5096245bf635b51a8289e1540f0f2c60747b263b0cc87849357257e3744ed8ac35a5613b675d69035c1788f38657188'
            'bd202e7604283a6b218b7bf0b8715e5061d80bdfba6d9a600093cbd8fc05525d9e587d90337f84b3594dc7217e7b62d79bc3b21cc575b1b81d9243019e91cb84'
            'e96bfcc14a7edb6f1e19395db9c8264ae29edec8ab9f7b771c4fb42ea7000dee404daaf77bcd16e06f862b433f425495459ea82dfc1f8447710ba3ef36699f66'
            'df62ec9ab79ec4f1468684c724b509f000d1430dce24dab14fc3e1e56acf44b95b477b3e088ad742055f632665592ba8829f65a953079bf7e085b16a9f1fa723'
            'abe6a509d7ceea8bb3a9c7dda6afd79dfdec380f93df8becefcee594b550e54bf42d9a23aeb341ea2b09697217e2d1ac4501b31d11e4c6fdf4de0d8e3f3ee9ae'
            'c072dbcc1e2dfd71aacd19e1717eeb50de80c4c7cc689b8d11c2b2b65884213dd9be85bcd1355f803d86325832d6577f0b3c344432eb2e0a3d392b286bdb7f9d'
            'ba44abc78a29584295b4adb57f95a8a74d55b29184c39dc15aa97d4a7b029a03c513738b0c279f2a8e5a2d3c72a6d7dc97da3f9367e88a5161b94bc24eb66600'
            '650f619568989693eb7ffa08b6108011552836a1cc61bd97c4ece8f1c092f4ef95ebb147e8ead9ce32c672f3d68f4c8ffe5a3fefa5792d12dbbc527a961a91c4'
            '3771fbd04c687ab2825b03ce4f5c05ff1236a52aba2aaef71545a74770767f251c15c0a38aedf5bd3734f0080d5078ee2f9202637111b6407829f098ed3997ee'
            'cac0e72de27d4a7e28f2017d94c819bd36e1717c12a9e4bf85e9fa8e922de3bca36e338be297b27507c40437a6ca4399b909fbecd5841975cc9d1e17f7bc2d8a'
            '5ac024acad6bacf5efbf8ab0167c2fdab0b6c54b8af85dce6e68ddf56b7485eab57178c52dc965822605ab42cedc80d36593b45a05f662730ea0f8427890b022'
            'fc4c925cd89b9eb78f200ba307d800729818394d47d12cf3804c90fb42e46a286b950857749ca9325c2823aa0f3d109d4673f0881eb634f270f2ae0e838def8f'
            'b601bf47e1ca43385b605778f0cf747af169cdef60f0f5809892bd9c2c6c659924e9d57556b11a0431cac1f0367ae043650e792cc9ffddfac6e2d1d52273d11e'
            'c55486de63a63f78e5d55c791352e4f724fb2115dd33e5c8bf2e1cdc6956b944b8a578e382b92827fc9b2f11b402c70dfc00423460c81a0b0e4272a5a9a0c9c0'
            '40f28e155884d1a72960bb4b76c5193b162299bc857073ec89bbeeea7571d4251f65079d91e229fedb4a0d1f7dbe047f86b972183f7ca76a493dd343232439b8'
            'e6da539caf5aa061ff506ebe068b9a9b8abd75af5968c9bc703e3668e3cb65f71965a1f51273bcd4f2df4a158e75ef47a9f2f32216016f0571bb8ec30c294a6c'
            '659e0e0e38a688b31c60cffd714f51069ad4c3f533af289bddf72765ca2474a5a6ae006347cdc8b1950b0d0a4d2e2ef6113a1647cdbb2a22b5b4167398edc05f'
            '186559a078bb53d00f2a58e10e466611e567a2bdb96a4f225ec7e84be961923260cdee758f3beb84149b29986c68444633390b4ec31448a7e97e3a32acbc1385'
            'e299ddd9078ecd657ed400b9a6e7206c7d98286a309548fe37a3ab1ed322ad23232c1526068c8dbf93f30f3a92bac587a0e6f4275322259fce3c65cdba0d3d1a'
            '030d3ce58df44d3ce4a191bca658d265ac1b77897072161e9d334f032430d9238062bdc8dc3b265ed3560940da8ee12af8ca42aa354da6b7e57d55db7967eb68'
            '26212c8d3d801a695fd5be78f52454e2215bebbde6a4394f616dd448a6a83a8e5aaab212b23b1e13f510281fa4ca64df4ad7f266925b10fabc4e390b610c5416'
            '48bc1bd2ade212c5110a5ca2431b0773fc083dc8293445fc0917b81cb03f9e7ad66337d45a38fd8ead69afe75af5fae5c010f8cf53216c98880ed2841ce64572'
            'ceb2f80578c30805ed7ca1a23096ebae8bd6d79d70318167015543d47ebb4ef6963f45753d40f526dbc11d0e10218a14f3b9aaee2af0684bcf064695ababa8b2'
            'de9a8d208293255c49328350f3844fc0f553c7a200ab69160f38c3465b513eb1b801b757a6a5a681d5a83f99f3273a89886213c5b06155860e9a1ce643a64227'
            '9f08920cf196185030fa76cbabc0b3691dd83d6e9fcb57b2b1a2f5bd9caf3d6ad49d93642241795d77b5f05e8e11c822c66b887f303640539bf44f3377f4d9a0'
            'd069f9eb0462817edb5263ecb7c611720c7d044e5ce06edf2629e8bbd4edd0bf6473106570941c78613ef0e5dd3eacd5c1b687b13fd91b5ae2693cf8c1180f51'
            '56e72bf29aa812c112fbf5f8a61bd13a11764b65ace1c69435deedb06c9aedcb18b40563a09e4eb48cc8ce4424691cd29a70a34acde3702d1be385ca901f0b3b'
            '8204f1db02781642f0d88ee4433a0a9f79946f12bd4d0684712791e56c5caa03a30828b219663f2b52308e40a50baa606a9b448b4324b79688fb7e51104dabda'
            '9d70e3758d97f0c54c45c02e42a6281296bee921778c899e0115a8e4351a9efa44584f49ce4a3188b0dff2eaa1840364166d7618f672b754bfb3d918a4fe0393'
            '6b0de6aa657211422cf2f9c13d936ebab43f4d7c001757622d99aa9077e9a06eb362c6ad33e6de4896f11c5882efb7a59a0e313429077b0154263ce11c61bc77'
            '67dbec919678f95d20522f271c3b0f986e3bd2d884f5ca5a5ff25a1a704b302d2d218feb652affaf1a798854e00fbaf8fc6cf1d300b37b297daa21286ad383f7'
            'ef1a49b2cb2efe8e3049432adad80429ebc8ca871aa50b8b8c594cbad7007d5e419d7f9d7e74a407aa838773562f0adaee01b7879dec8fa67f82a81f76d7514f'
            '77bc5c2846c9a4708706916107e02e0a0617398071521af03a832ab3e7f8f2b729b91cde7930e42cadeebe377b80e5e67c6ac2e510a5cc7209e58c73423a00d5'
            '199768e16920c579e9f020470f0fd4f5e69035f5b6a849e01afdcd111148a5869412fe2ae96b6c98b0882f44a7def9966efc687381350e5901c354d47bb55022'
            'c2f562ce49354aecfb45479f2a390ad6dc9c496301fb94f7f1924a68cd14b2ff851172f5eb591d31ccfbe7bc6acad6620f31304022d1345ec8c761c1377603ac'
            '0861fedc181538a42fe26aa5a7562a469bb1b60ebd384573c22b2ab13b32d1021233cebe7adadf9c26ce1e62fc38c589bda13f7b16bb7541c9074147fb6e999d'
            '226a61e1e030e2eab3978b3ea11d741699223f60d1fc41e15f623d3f5309802a61b744e162eec406a5539fc7ffd99da679b3bd34396abaaf7720a3206695f550'
            '13a4a7377026f6ee0deb67083129855707c58604096145913959715265840502e52fb01203daa9bcbfcfe1d8290fa2668043398647674c4e1106e5bffa4c6e19'
            '4a6a1ea2cfc603088d689d65a6df254c851271c44a24feeaef953875432e9892790e20216b46892cdfb434957525d5e6effd9f737491e0b4c3ae06832ee0fa4b'
            'b5ce13c0e8dc573099575f525596e58d3d7f094f59f29fcbd4871ae7d928c57354dc1e16268f199071a06aa3c907bb03ffaee7a6e2d1701ab59d36a3c359647b'
            '8aaf98ab4f5d1ba3521a1c7d44578462dd80105b7a175fd9bcb73444098e27e1062890479eeef151ab9be8c01201d309208a279ed8fa4c203c6fc416dc4ace8f'
            'faf9dc12e5090393c9af5354c1554525541d896d3cfe85b4ad1630ebdbb9ccb527fe59f3714eca430e775752cc698deaddc7d1a0cb6d6a514929b36372024718')

pkgver() {
  cd "${srcdir}"/$_realname
  local _ver=$(git describe | awk -F"-" '{ print $1}' | sed 's/n//g')
  printf "%s.%s.%s" "${_ver}" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
  cd "${srcdir}"/$_realname

  if [ -f "libavcodec/x86/hevc_idct_intrinsic.c" ]; then
    rm -f libavcodec/x86/hevc_idct_intrinsic.c
  fi
  if [ -f "libavcodec/x86/hevc_intra_intrinsic.c" ]; then
    rm -f libavcodec/x86/hevc_intra_intrinsic.c
  fi
  if [ -f "libavcodec/x86/hevcpred.h" ]; then
    rm -f libavcodec/x86/hevcpred.h
  fi
  if [ -f "compat/windows/dxva_hevc.h" ]; then
    rm -f compat/windows/dxva_hevc.h
  fi

  local -i _N=66
  local -i _i
  local _num
  msg2 'Apply patches'
  for _i in $(seq 1 ${_N})
  do
    _num=$(printf "%04d" ${_i})
    printf "\n========== patch No.%s ==========\n" $_num
    patch -p1 -i "${srcdir}"/${_num}*.patch
  done
}

build() {
  cd "${srcdir}"/$_realname

  if [ "${MINGW_CARCH}" = "x86_64" ]; then
    PATH=${PATH}:$VC64_DIR
  else
    PATH=${PATH}:$VC32_DIR
  fi
  export PATH

  if [ -f "${MINGW_LOCAL_PREFIX}/include/nvEncodeAPI.h" ]; then
    local _nvenc='--enable-nvenc --enable-nonfree'
  else
    local _nvenc=''
  fi

  ./configure \
    --prefix=$MINGW_LOCAL_PREFIX \
    --enable-gpl \
    --enable-version3 \
    --disable-static \
    --enable-shared \
    --enable-gray \
    --enable-avresample \
    --disable-pthreads \
    --enable-avisynth \
    --enable-libdcadec \
    --enable-libmfx \
    --enable-libopencore-amrnb \
    --enable-libopencore-amrwb \
    --enable-libopenh264 \
    --enable-libopenjpeg \
    --enable-libopus \
    --enable-libspeex \
    --enable-libutvideo \
    --enable-libvorbis \
    --enable-libvpx \
    --enable-libx264 \
    --enable-libx265 \
    $_nvenc \
    --enable-opencl \
    --enable-opengl \
    --arch=${MINGW_CARCH/i6/x} \
    --cpu=sandybridge \
    --extra-ldflags="${LDFLAGS}" \
    --optflags="${CFLAGS} ${CPPFLAGS}" \
    --disable-symver \
    --sws-max-filter-size=512 \
    --disable-debug

  make clean
  make $MAKEFLAGS V=1
}

package() {
  cd "${srcdir}"/$_realname
  make DESTDIR="${pkgdir}" install install-man V=1
}
