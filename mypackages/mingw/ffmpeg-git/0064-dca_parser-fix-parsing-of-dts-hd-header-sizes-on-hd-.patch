From cfc4324e389aff32fa7a45109396648ac0a0e1f7 Mon Sep 17 00:00:00 2001
From: Hendrik Leppkes <h.leppkes@gmail.com>
Date: Sun, 29 Mar 2015 11:57:12 +0200
Subject: [PATCH 65/65] dca_parser: fix parsing of dts-hd header sizes on
 hd-only streams

Previously it would always parse the size of the next frame, which
resulted on broken playback as two frames were packed into one AVPacket.
---
 libavcodec/dca_parser.c | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

diff --git a/libavcodec/dca_parser.c b/libavcodec/dca_parser.c
index e26252b..79aa414 100644
--- a/libavcodec/dca_parser.c
+++ b/libavcodec/dca_parser.c
@@ -52,10 +52,10 @@ static int dca_parse_hd_framesize(const uint8_t *buf, int buf_size, int *framesi
 
     if (get_bits1(&gb)) {
         skip_bits(&gb, 12);
-        *framesize = get_bits(&gb, 20);
+        *framesize = get_bits(&gb, 20) + 1;
     } else {
         skip_bits(&gb, 8);
-        *framesize = get_bits(&gb, 16);
+        *framesize = get_bits(&gb, 16) + 1;
     }
 
     return 0;
@@ -84,6 +84,10 @@ static int dca_find_frame_end(DCAParseContext *pc1, const uint8_t *buf,
                 if (!pc1->lastmarker || state == pc1->lastmarker || pc1->lastmarker == DCA_SYNCWORD_SUBSTREAM) {
                     start_found     = 1;
                     pc1->lastmarker = state;
+                    if (state == DCA_SYNCWORD_SUBSTREAM) {
+                      if (dca_parse_hd_framesize(&buf[i + 1], buf_size - (i + 1), &pc1->hdframesize) < 0)
+                        pc1->hdframesize = 0;
+                    }
                     i++;
                     break;
                 }
@@ -94,7 +98,7 @@ static int dca_find_frame_end(DCAParseContext *pc1, const uint8_t *buf,
         for (; i < buf_size; i++) {
             pc1->size++;
             state = (state << 8) | buf[i];
-            if (state == DCA_SYNCWORD_SUBSTREAM && pc1->size >= pc1->framesize && !pc1->hdframesize) {
+            if (state == DCA_SYNCWORD_SUBSTREAM && pc1->lastmarker != DCA_SYNCWORD_SUBSTREAM && pc1->size >= pc1->framesize && !pc1->hdframesize) {
                 if (dca_parse_hd_framesize(&buf[i+1], buf_size - (i+1), &pc1->hdframesize) < 0)
                     pc1->hdframesize = 0;
             }
-- 
2.3.5

