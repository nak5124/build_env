From bd1cc279d81ff7487d9a2403a6ecd9a0cb2cff9e Mon Sep 17 00:00:00 2001
From: Hendrik Leppkes <h.leppkes@gmail.com>
Date: Sat, 21 Feb 2015 11:51:28 +0100
Subject: [PATCH 62/65] hevc_parser: search for a sps/pps combination instead
 of only one when splitting

---
 libavcodec/hevc_parser.c | 12 ++++++++----
 1 file changed, 8 insertions(+), 4 deletions(-)

diff --git a/libavcodec/hevc_parser.c b/libavcodec/hevc_parser.c
index 04fa052..028872a 100644
--- a/libavcodec/hevc_parser.c
+++ b/libavcodec/hevc_parser.c
@@ -288,16 +288,20 @@ static int hevc_split(AVCodecContext *avctx, const uint8_t *buf, int buf_size)
 {
     const uint8_t *ptr = buf, *end = buf + buf_size;
     uint32_t state = -1;
-    int has_ps = 0, nut;
+    int has_sps = 0, has_pps = 0, nut;
 
     while (ptr < end) {
         ptr = avpriv_find_start_code(ptr, end, &state);
         if ((state >> 8) != START_CODE)
             break;
         nut = (state >> 1) & 0x3F;
-        if (nut >= NAL_VPS && nut <= NAL_PPS)
-            has_ps = 1;
-        else if (has_ps)
+        if (nut >= NAL_VPS && nut <= NAL_PPS) {
+            if (nut == NAL_SPS)
+                has_sps = 1;
+            else if (nut == NAL_PPS)
+                has_pps = 1;
+        }
+        else if (has_sps && has_pps)
             return ptr - 4 - buf;
     }
     return 0;
-- 
2.3.5

