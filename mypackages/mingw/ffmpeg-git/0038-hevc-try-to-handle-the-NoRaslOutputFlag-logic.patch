From 5b0dd167f31ab7243ed2bbde1c68d99308a0057b Mon Sep 17 00:00:00 2001
From: Hendrik Leppkes <h.leppkes@gmail.com>
Date: Sat, 13 Dec 2014 21:21:00 +0100
Subject: [PATCH 38/63] hevc: try to handle the NoRaslOutputFlag logic

---
 libavcodec/hevc.c      | 8 ++++++++
 libavcodec/hevc.h      | 1 +
 libavcodec/hevc_refs.c | 2 +-
 3 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/libavcodec/hevc.c b/libavcodec/hevc.c
index cfa62b6..25d0124 100644
--- a/libavcodec/hevc.c
+++ b/libavcodec/hevc.c
@@ -2610,6 +2610,9 @@ static int hevc_frame_start(HEVCContext *s)
     if (ret < 0)
         goto fail;
 
+    if (IS_IRAP(s))
+        s->NoRaslOutputFlag = 0;
+
     if (!s->avctx->hwaccel)
         ff_thread_finish_setup(s->avctx);
 
@@ -2770,6 +2773,8 @@ static int decode_nal_units(HEVCContext *s, const uint8_t *buf, int length)
 
     s->ref = NULL;
     s->last_eos = s->eos;
+    if (s->last_eos)
+      s->NoRaslOutputFlag = 1;
     s->eos = 0;
 
     /* split the input packet into NAL units, so we know the upper bound on the
@@ -3135,6 +3140,7 @@ static int hevc_update_thread_context(AVCodecContext *dst,
     s->pocTid0    = s0->pocTid0;
     s->max_ra     = s0->max_ra;
     s->eos        = s0->eos;
+    s->NoRaslOutputFlag = s0->NoRaslOutputFlag;
 
     s->is_nalff        = s0->is_nalff;
     s->nal_length_size = s0->nal_length_size;
@@ -3239,6 +3245,7 @@ static av_cold int hevc_decode_init(AVCodecContext *avctx)
 
     s->enable_parallel_tiles = 0;
     s->picture_struct = 0;
+    s->NoRaslOutputFlag = 1;
 
     if(avctx->active_thread_type & FF_THREAD_SLICE)
         s->threads_number = avctx->thread_count;
@@ -3280,6 +3287,7 @@ static void hevc_decode_flush(AVCodecContext *avctx)
     HEVCContext *s = avctx->priv_data;
     ff_hevc_flush_dpb(s);
     s->max_ra = INT_MAX;
+    s->NoRaslOutputFlag = 1;
 }
 
 #define OFFSET(x) offsetof(HEVCContext, x)
diff --git a/libavcodec/hevc.h b/libavcodec/hevc.h
index 32d6da9..196191a 100644
--- a/libavcodec/hevc.h
+++ b/libavcodec/hevc.h
@@ -866,6 +866,7 @@ typedef struct HEVCContext {
     int bs_height;
 
     int is_decoded;
+    int NoRaslOutputFlag;
 
     HEVCPredContext hpc;
     HEVCDSPContext hevcdsp;
diff --git a/libavcodec/hevc_refs.c b/libavcodec/hevc_refs.c
index 0c1dbb2..42de575 100644
--- a/libavcodec/hevc_refs.c
+++ b/libavcodec/hevc_refs.c
@@ -174,7 +174,7 @@ int ff_hevc_output_frame(HEVCContext *s, AVFrame *out, int flush)
         int min_poc   = INT_MAX;
         int i, min_idx, ret;
 
-        if (s->sh.no_output_of_prior_pics_flag == 1) {
+        if (s->sh.no_output_of_prior_pics_flag == 1 && s->NoRaslOutputFlag) {
             for (i = 0; i < FF_ARRAY_ELEMS(s->DPB); i++) {
                 HEVCFrame *frame = &s->DPB[i];
                 if (!(frame->flags & HEVC_FRAME_FLAG_BUMPING) && frame->poc != s->poc &&
-- 
2.5.0

